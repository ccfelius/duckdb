name: PythonDebug
on:
  [push, pull_request]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.head_ref || '' }}-${{ github.base_ref || '' }}-${{ github.ref != 'refs/heads/master' || github.sha }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

env:
  GH_TOKEN: ${{ secrets.GH_TOKEN }}
  TWINE_PASSWORD: ${{ secrets.TWINE_PASSWORD }}
  AWS_ACCESS_KEY_ID: AKIAVBLKPL2ZW2T7TYFQ
  AWS_SECRET_ACCESS_KEY: ${{ secrets.NODE_PRE_GYP_SECRETACCESSKEY }}
  NODE_AUTH_TOKEN: ${{secrets.NODE_AUTH_TOKEN}}

jobs:
 python-debug-linux:
    name: Python Debug - Linux (64 Bit)
    runs-on: ubuntu-latest
    container: ubuntu:16.04
    env:
      GEN: ninja
      BUILD_PYTHON: 1
      TREAT_WARNINGS_AS_ERRORS: 1
      FORCE_WARN_UNUSED: 1
      CIBW_BUILD: 'cp39-manylinux_x86_64'
      SETUPTOOLS_SCM_NO_LOCAL: 'yes'
      TWINE_USERNAME: 'hfmuehleisen'
      PYTEST_TIMEOUT: '600'

    steps:
    - uses: actions/checkout@v2
      with:
        fetch-depth: 0

    - name: Install
      run: |
        apt-get update -y -qq
        apt-get install -y -qq software-properties-common
        add-apt-repository ppa:git-core/ppa
        apt-get update -y -qq
        apt-get install -y -qq git ninja-build make gcc-multilib g++-multilib libssl-dev wget openjdk-8-jdk zip maven unixodbc-dev libffi-dev


    - name: Install Python 3.9
      run: |
        wget https://www.python.org/ftp/python/3.9.9/Python-3.9.9.tgz
        tar xvf Python-3.9.9.tgz
        cd Python-3.9.9
        mkdir -p pythonbin
        ./configure --with-ensurepip=install --with-pydebug  
        make -j
        make install
        python3.9 --version
        python3.9 -m pip install pip
        python3.9 -m pip install requests
        python3.9 -m pip install cibuildwheel
        python3.9 -m pip install --prefer-binary "pandas>=0.24" pytest-timeout mypy "requests>=2.26" "pyarrow==7.0"

    - name: Install CMake
      run: |
        wget https://github.com/Kitware/CMake/releases/download/v3.21.3/cmake-3.21.3-linux-x86_64.sh
        chmod +x cmake-3.21.3-linux-x86_64.sh
        ./cmake-3.21.3-linux-x86_64.sh --skip-license --prefix=/usr/local

    - name: Build
      run: |
        cd tools/pythonpkg
        python3.9 setup.py install

    - name: Run Tests
      run: python3.9 -m pytest {project}/tests/fast
