# name: test/optimizer/zonemaps.test
# description: Test if zonemaps are correctly used
# group: [optimizer]

statement ok
PRAGMA explain_output = PHYSICAL_ONLY;

statement ok
create temporary table t as select range a, length(range) b, mod(range,10000) c, 5 d, 10000 e from range(100000);

# Zonemap checks

query II
explain select count(*) from t where a >=2 and a < 7 or a in (1,3,8);
----
physical_plan	<REGEX>:.* Zonemaps Checks: .*a>=1.*a<=8.*


# 1) In-clause based on in-clause range/boundary zonemap check
query II
explain select count(*) from t where b in (1,2,3) ;
----
physical_plan	<REGEX>:.*Filters:.*b<=3.*

query II
explain select count(*) from t where b <=3 and b>=0;
----
physical_plan	<REGEX>:.*Filters:.*b<=3.*

#   2) In-clause based on in-clause range/boundary zonemap check

query II
explain select count(*) from t where b in (1, 3) ;
----
physical_plan	<REGEX>:.*Zonemaps Checks:.*b>=1.*b<=3.*

query II
explain select count(*) from t where b = 1 or b = 3 ;
----
physical_plan	<REGEX>:.*Zonemaps Checks:.*b>=1.*b<=3.*


#   3) Transitive Filters
query II
explain select count(*) from t where b < 5 and d = 5;     /* data skipping occurs */
----
physical_plan	<REGEX>:.*Filters:.*d=5.*b<5.*

query II
explain select count(*) from t where  d = 5 and b < d;
----
physical_plan	<REGEX>:.*Filters:.*b<5.*d=5.*

#   4)  Check zonemap before joins
statement ok
create temporary table t1 as select range a, length(range) nationkey from range(100000);

statement ok
create table t2 as select range  nationkey, concat('Nation_',range) n_name from range(25);

query II
explain select count(*) from t1 join t2 using (nationkey)
where t2.n_name = 'Nation_1' and t1.nationkey =1;
----
physical_plan	<REGEX>:.*Filters:.*nationkey=1.*Filters:.*nationkey=1.*n_name=Nation_1.*

query II
explain select count(*) from t1 join t2 using (nationkey)
where t2.n_name = 'Nation_1' and t2.nationkey =1;
----
physical_plan	<REGEX>:.*Filters:.*nationkey=1.*Filters:.*nationkey=1.*n_name=Nation_1.*

query II
explain select count(*) from t1 join t2 using (nationkey) where t2.n_name = 'Nation_1';
----
physical_plan	<REGEX>:.*Filters:.*n_name=Nation_1.*

query II
explain select count(*) from t1 join t2 using (nationkey) where t2.nationkey =2 or n_name= 'Nation_2';
----
physical_plan	<REGEX>:.*Zonemaps Checks:.*nationkey>=2.*nationkey<=2.*n_name>=Nation_2.*n_name<=Nation_2.*

query II
explain select count(*) from t1 join t2 using (nationkey) where t2.n_name in ( 'Nation_1', 'Nation_2');
----
physical_plan	<REGEX>:.*Zonemaps Checks:.*n_name>=Nation_1.*n_name<=Nation_2.*