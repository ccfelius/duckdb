# name: test/optimizer/regex_optimizer.test
# description: Test Like Optimization Rules
# group: [optimizer]

statement ok
CREATE TABLE test(s VARCHAR);

statement ok
PRAGMA explain_output = OPTIMIZED_ONLY;

statement ok
INSERT INTO test VALUES ('aaa');

# contains optimization: /aaa/ -> contains(aaa)
query I nosort regexconstantpattern
EXPLAIN SELECT regexp_matches(s, 'aa') FROM test
----

query I nosort regexconstantpattern
EXPLAIN SELECT contains(s, 'aa') FROM test
----


# contains optimization: /a/ -> contains(aaa)
query I nosort regexconstantsinglechar
EXPLAIN SELECT regexp_matches(s, 'a') FROM test
----

query I nosort regexconstantsinglechar
EXPLAIN SELECT contains(s, 'a') FROM test
----

query I nosort correct_result
SELECT regexp_matches(s, '[a]') FROM test
----

query I nosort correct_result
SELECT regexp_matches(s, 'a') FROM test
----

query I nosort correct_result
SELECT contains(s, 'aaa') FROM test
----


query I nosort correct_result
SELECT regexp_matches(s, '^a') FROM TEST;
----
aaa

query I nosort correct_result
SELECT regexp_matches(s, '^aa') FROM TEST;
----
aaa

statement ok
DELETE FROM test;

statement ok
INSERT INTO test VALUES ('aaa'), ('a.a'), ('baba'), ('abba'), ('a\.a');

query II nosort converttolike
explain select regexp_matches(s, 'a.a'), s from test;
----
physical_plan	<REGEX>:'.*%a_a%.*'


query II nosort converttolike2
explain SELECT regexp_matches(s, 'a.*a'), s FROM TEST;
----
physical_plan	<REGEX>:'%a%a%'

query II nosort converttolike3
explain SELECT regexp_matches(s, '^a.*b$'), s FROM TEST;
----
physical_plan <REGEX>:"~~(s, 'a%b')"

query II nosort converttolike5
explain select regexp_matches(s, 'a\.a'), s from test;
----
physical_plan	<REGEX>:".*contains(s, 'a.a').*"

query II nosort prefix
explain SELECT regexp_matches(s, '^a'), s FROM TEST;
----
physical_plan	<REGEX>:"prefix(s, 'a')"

query II nosort suffix
explain SELECT regexp_matches(s, 'a$'), s FROM TEST;
----
physical_plan	<REGEX>:"suffix(s, 'a')"

query II nosort converttolike6
explain select regexp_matches(s, '.*green.*'), s, from test;
----
physical_plan	<REGEX>:"prefix(s, '%green%')"

query II nosort converttolike7
explain select regexp_matches(s, '.*special.*requests.*'), s from test;
----
physical_plan	<REGEX>:"prefix(s, '%special%requests%')"

