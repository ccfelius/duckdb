# name: test/extension/autoloading_current_setting.test
# description: More tests for extension autoloading.
# group: [extension]

# This test assumes icu and json to be available in the LOCAL_EXTENSION_REPO and NOT linked into duckdb statically
# -> this should be the case for our autoloading tests where we have the local_extension_repo variable set
require-env LOCAL_EXTENSION_REPO

statement ok
set extension_directory='__TEST_DIR__/autoloading_current_setting'

# Default should be true when running this unit tests
query I
select value from duckdb_settings() where name='autoload_known_extensions';
----
true

### No autoloading: throw error with installation hint
statement ok
set autoload_known_extensions=false

statement error
select current_setting('timezone');
----
Catalog Error: Setting with name "timezone" is not in the catalog, but it exists in the icu extension.


### Autoloading, but the autoloading repository is set to non-existent location
statement ok
set autoload_known_extensions=true

# Override the default repo with a non-existent dir
statement ok
set autoinstall_extension_repository='/tmp/non-existent-repo';

# Error should inform the user on whats happening
statement error
select current_setting('timezone');
----
IO Error: Attempted to automatically install the 'icu' extension, but the following error occured: (Failed to copy local extension "icu" at PATH

### Autoloading with correct tmp repo
statement ok
set autoinstall_extension_repository='${LOCAL_EXTENSION_REPO}';

statement ok
select current_setting('timezone');
