# name: test/sql/window/test_window_distinct.test
# description: Windowed distinct aggregates
# group: [window]

statement ok
PRAGMA enable_verification

query I
SELECT COUNT(DISTINCT 42) OVER ()
----
1

query IIII
WITH t AS (
	SELECT col0 AS a, col1 AS b 
	FROM (VALUES
		(1,2),
		(1,1),
		(1,2),
		(2,1),
		(2,1),
		(2,2),
		(2,3),
		(2,4)
	) v) 
SELECT *, COUNT(b) OVER(PARTITION BY a), COUNT(DISTINCT b) OVER(PARTITION BY a) 
FROM t
ORDER BY 1, 2
----
1	1	3	2
1	2	3	2
1	2	3	2
2	1	5	4
2	1	5	4
2	2	5	4
2	3	5	4
2	4	5	4

statement ok
CREATE TABLE figure1 AS 
	SELECT * 
	FROM VALUES 
			(1, 'a'),
			(2, 'b'),
			(3, 'b'),
			(4, 'c'),
			(5, 'c'),
			(6, 'b'),
			(7, 'c'),
			(8, 'a')
		v(i, s);

query III
SELECT i
	, s
	, COUNT(DISTINCT s) OVER( ORDER BY i ROWS BETWEEN 2 PRECEDING AND 2 FOLLOWING) AS c
FROM figure1
ORDER BY i
----
1	a	2
2	b	3
3	b	3
4	c	2
5	c	2
6	b	3
7	c	3
8	a	3

query III
WITH uncascaded AS (
	SELECT i, i % 29 AS v 
	FROM range(1000) tbl(i)
)
SELECT i
	, v
	, COUNT(DISTINCT v) OVER (ORDER BY i ROWS BETWEEN 25 PRECEDING AND 25 FOLLOWING) AS w
FROM uncascaded
ORDER BY i
----
3000 values hashing to cb9c296986f7b9eaeee380bbc049ab39

query III
WITH cascaded AS (
	SELECT i, i % 29 AS v 
	FROM range(10000) tbl(i)
)
SELECT i
	, v
	, COUNT(DISTINCT v) OVER (ORDER BY i ROWS BETWEEN 25 PRECEDING AND 25 FOLLOWING) AS w
FROM cascaded
ORDER BY i
----
30000 values hashing to 673869e81fecab82f0bcec032236115a


# Exclude falls back to na√Øve
query IIII
SELECT i
	, s
	, i // 2 AS o
	, COUNT(DISTINCT s) OVER(
		ORDER BY i // 2
		ROWS BETWEEN 2 PRECEDING AND 2 FOLLOWING 
		EXCLUDE TIES
	) AS c
FROM figure1
ORDER BY i
----
1	a	0	2
2	b	1	3
3	b	1	3
4	c	2	2
5	c	2	2
6	b	3	3
7	c	3	2
8	a	4	3
