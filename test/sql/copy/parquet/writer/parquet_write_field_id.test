# name: test/sql/copy/parquet/writer/parquet_write_field_id.test
# description: Parquet writer FIELD_IDS tests
# group: [writer]

require parquet

statement ok
pragma enable_verification

# need to supply an argument
statement error
copy (select range as i from range(10)) to '__TEST_DIR__/my.parquet' (FIELD_IDS)
----
Binder Error

# j is not present so we can't have a field id
statement error
copy (select range as i from range(10)) to '__TEST_DIR__/my.parquet' (FIELD_IDS {j:42})
----
Binder Error

# this should work
statement ok
copy (select range as i from range(10)) to '__TEST_DIR__/my.parquet' (FIELD_IDS {i:42})

query I
select field_id from parquet_schema('__TEST_DIR__/my.parquet') where name = 'i'
----
42

# can't have duplicate field id keys
statement error
copy (select range as i, range as j from range(10)) to '__TEST_DIR__/my.parquet' (FIELD_IDS {i:42,i:43})
----
Binder Error

# can't have duplicate field id values either
statement error
copy (select range as i, range as j from range(10)) to '__TEST_DIR__/my.parquet' (FIELD_IDS {i:42,j:42})
----
Binder Error

# we don't have to supply a field_id for all columns
statement ok
copy (select range as i, range as j from range(10)) to '__TEST_DIR__/my.parquet' (FIELD_IDS {i:42})

query I
select field_id from parquet_schema('__TEST_DIR__/my.parquet') where name = 'i'
----
42

query I
select field_id from parquet_schema('__TEST_DIR__/my.parquet') where name = 'j'
----
NULL

# but we can
statement ok
copy (select range as i, range as j from range(10)) to '__TEST_DIR__/my.parquet' (FIELD_IDS {i:42,j:43})

query I
select field_id from parquet_schema('__TEST_DIR__/my.parquet') where name = 'i'
----
42

query I
select field_id from parquet_schema('__TEST_DIR__/my.parquet') where name = 'j'
----
43

# we can also specify the col like this
statement ok
copy (select range as i, range as j from range(10)) to '__TEST_DIR__/my.parquet' (FIELD_IDS {i:{field_id:42},j:{field_id:43}})

query I
select field_id from parquet_schema('__TEST_DIR__/my.parquet') where name = 'i'
----
42

query I
select field_id from parquet_schema('__TEST_DIR__/my.parquet') where name = 'j'
----
43

# i is not a nested type, so we can't specify nested field ids
statement error
copy (select range as i, range as j from range(10)) to '__TEST_DIR__/my.parquet' (FIELD_IDS {i:{field_id:42,nested:{j:43}}})
----
Binder Error

# we tested a non-nested column type, now do all the nested types so we test all the code paths

# list
statement ok
copy (select range(range, range + 3) as i from range(10)) to '__TEST_DIR__/my.parquet' (FIELD_IDS {i:{field_id:42,nested:{element:43}}})

query I
select field_id from parquet_schema('__TEST_DIR__/my.parquet') where name = 'i'
----
42

query I
select field_id from parquet_schema('__TEST_DIR__/my.parquet') where name = 'element'
----
43

# we don't have to specify a field_id for the top-level list, we can also just specify for the nested children
statement ok
copy (select range(range, range + 3) as i from range(10)) to '__TEST_DIR__/my.parquet' (FIELD_IDS {i:{nested:{element:43}}})

query I
select field_id from parquet_schema('__TEST_DIR__/my.parquet') where name = 'i'
----
NULL

query I
select field_id from parquet_schema('__TEST_DIR__/my.parquet') where name = 'element'
----
43

# list child is always called "element"
statement error
copy (select range(range, range + 3) as i from range(10)) to '__TEST_DIR__/my.parquet' (FIELD_IDS {i:{field_id:42,nested:{elem:43}}})
----
Binder Error: Column name "elem" in FIELD_IDS not found. Available column names: [element]

# struct
statement ok
copy (select {f : range} as i from range(10)) to '__TEST_DIR__/my.parquet' (FIELD_IDS {i:{field_id:42,nested:{f:43}}})

query I
select field_id from parquet_schema('__TEST_DIR__/my.parquet') where name = 'i' and num_children > 0
----
42

query I
select field_id from parquet_schema('__TEST_DIR__/my.parquet') where name = 'f'
----
43

# struct does not have child "g"
statement error
copy (select {f : range} as i from range(10)) to '__TEST_DIR__/my.parquet' (FIELD_IDS {i:{field_id:42,nested:{g:43}}})
----
Binder Error: Column name "g" in FIELD_IDS not found. Available column names: [f]

# map
statement ok
copy (select map {range : 10 - range} as i from range(10)) to '__TEST_DIR__/my.parquet' (FIELD_IDS {i:{field_id:42,nested:{key:43,value:44}}})

query I
select field_id from parquet_schema('__TEST_DIR__/my.parquet') where name = 'i' and num_children > 0
----
42

query I
select field_id from parquet_schema('__TEST_DIR__/my.parquet') where name = 'key'
----
43

query I
select field_id from parquet_schema('__TEST_DIR__/my.parquet') where name = 'value'
----
44

# map type children need to be called "key" and "value"
statement error
copy (select map {range : 10 - range} as i from range(10)) to '__TEST_DIR__/my.parquet' (FIELD_IDS {i:{field_id:42,nested:{k:43,v:44}}})
----
Binder Error: Column name "k" in FIELD_IDS not found. Available column names: [key, value]

# test auto-generation (flat)
statement ok
copy (select range as i, range as j from range(10)) to '__TEST_DIR__/my.parquet' (FIELD_IDS 'auto')

query I
select field_id from parquet_schema('__TEST_DIR__/my.parquet') where name = 'i'
----
0

query I
select field_id from parquet_schema('__TEST_DIR__/my.parquet') where name = 'j'
----
1

# big nestedness
statement ok
copy (select map {'my_key' : [{j : 42}]} as i) to '__TEST_DIR__/my.parquet' (FIELD_IDS {i:{field_id:42,nested:{key:43,value:{field_id:44,nested:{element:{field_id:45,nested:{j:46}}}}}}})

query II
select name, field_id from parquet_schema('__TEST_DIR__/my.parquet') where name in ('i', 'key', 'value', 'element', 'j') order by field_id
----
i	42
key	43
value	44
element	45
j	46

# columns need to be called "field_id" and "nested"
statement error
copy (select {f : range} as i from range(10)) to '__TEST_DIR__/my.parquet' (FIELD_IDS {i:{field_id:42,nest:43}})
----
Binder Error

statement error
copy (select {f : range} as i from range(10)) to '__TEST_DIR__/my.parquet' (FIELD_IDS {i:{fieldid:42,nested:43}})
----
Binder Error

# test auto-generation (list)
statement ok
copy (select range(range, range + 3) as i from range(10)) to '__TEST_DIR__/my.parquet' (FIELD_IDS 'auto')

query I
select field_id from parquet_schema('__TEST_DIR__/my.parquet') where name = 'i'
----
0

query I
select field_id from parquet_schema('__TEST_DIR__/my.parquet') where name = 'element'
----
1

# test auto-generation (struct)
statement ok
copy (select {f : range} as i from range(10)) to '__TEST_DIR__/my.parquet' (FIELD_IDS 'auto')

query I
select field_id from parquet_schema('__TEST_DIR__/my.parquet') where name = 'i' and num_children > 0
----
0

query I
select field_id from parquet_schema('__TEST_DIR__/my.parquet') where name = 'f'
----
1

# test auto-generation (map)
statement ok
copy (select map {range : 10 - range} as i from range(10)) to '__TEST_DIR__/my.parquet' (FIELD_IDS 'auto')

query I
select field_id from parquet_schema('__TEST_DIR__/my.parquet') where name = 'i' and num_children > 0
----
0

query I
select field_id from parquet_schema('__TEST_DIR__/my.parquet') where name = 'key'
----
1

query I
select field_id from parquet_schema('__TEST_DIR__/my.parquet') where name = 'value'
----
2

# test auto-generation (big nestedness)
statement ok
copy (select map {'my_key' : [{j : 42}]} as i) to '__TEST_DIR__/my.parquet' (FIELD_IDS 'auto')

query II
select name, field_id from parquet_schema('__TEST_DIR__/my.parquet') where name in ('i', 'key', 'value', 'element', 'j') order by field_id
----
i	0
key	1
value	2
element	3
j	4
