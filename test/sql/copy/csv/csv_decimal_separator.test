# name: test/sql/copy/csv/csv_decimal_separator.test
# description: Support decimal separators
# group: [csv]

statement ok
PRAGMA enable_verification

# when comma is specified as decimal separator, we can read data with comma or period as decimal separator,
# because commas are just converted to periods
statement ok
CREATE TABLE decimal_separators AS SELECT * FROM read_csv_auto('data/csv/decimal_separators/decimal_separators.csv', header=1, column_types={'commas': 'double', 'periods': 'double'}, delim=';', decimal_separator=',')

query II
SELECT commas, periods FROM decimal_separators;
----
1.1	1.1
0.25	0.25
15300.0	1.53e4
15300.0	+1.53e4
-15300.0	-1.53e4

query II
SELECT typeof(commas), typeof(periods) FROM decimal_separators limit 1;
----
DOUBLE	DOUBLE

# reading the commas column as decimal fails when decimal separator is set to '.'
statement error
CREATE TABLE decimal_separators2 AS SELECT * FROM read_csv_auto('data/csv/decimal_separators/decimal_separators.csv', header=1, column_types={'commas': 'decimal', 'periods': 'decimal'}, delim=';', decimal_separator='.')

# reading the commas column as double fails when decimal separator is set to '.'
statement error
CREATE TABLE decimal_separators2 AS SELECT * FROM read_csv_auto('data/csv/decimal_separators/decimal_separators.csv', header=1, column_types={'commas': 'double', 'periods': 'decimal'}, delim=';', decimal_separator='.')

# reading the commas column as float fails when decimal separator is set to '.'
statement error
CREATE TABLE decimal_separators2 AS SELECT * FROM read_csv_auto('data/csv/decimal_separators/decimal_separators.csv', header=1, column_types={'commas': 'float', 'periods': 'decimal'}, delim=';', decimal_separator='.')


statement ok
CREATE TABLE decimal_separators2 AS SELECT * FROM read_csv_auto('data/csv/decimal_separators/decimal_separators.csv', header=1, column_types={'commas': 'decimal', 'periods': 'decimal'}, delim=';', decimal_separator=',')

query II
SELECT commas, periods FROM decimal_separators2;
----
1.100	1.1
0.250	0.25
15300.000	1.53e4
15300.000	+1.53e4
-15300.000	-1.53e4

query II
SELECT typeof(commas), typeof(periods) FROM decimal_separators2 limit 1;
----
DECIMAL(18,3)	DECIMAL(18,3)


# no separator specified => commas get read as varchar
statement ok
CREATE TABLE decimal_separators3 AS SELECT * FROM read_csv_auto('data/csv/decimal_separators/decimal_separators.csv', header=1, column_types={'periods': 'decimal'}, delim=';')

query II
SELECT commas, periods FROM decimal_separators3;
----
1,1	1.100
0,25	0.250
1,53e4	15300.000
+1,53e4	+15300.000
-1,53e4	-15300.000


# in a comma-delimited file, comma as decimal separator is OK when quoted
statement ok
CREATE TABLE decimal_separators4 AS SELECT * FROM read_csv_auto('data/csv/decimal_separators/decimal_separators_csv.csv', header=1, column_types={'commas': 'double'}, quote='"',delim=',',decimal_separator=',')

query II
SELECT commas, periods FROM decimal_separators4;
----
1.2345	1.2345


# unsupported separator characters result in error
statement error
SELECT * FROM read_csv_auto('data/csv/decimal_separators/invalid_char.csv', header=1, column_types={'foo': 'double'}, decimal_separator='รถ')


# numbers in format 1,000.00 become 1.000.00 after conversion and thus fail reading
statement error
SELECT * FROM read_csv_auto('data/csv/decimal_separators/thousands_fail.csv', header=1, column_types={'foo': 'double'}, decimal_separator=',')


# data can still contain entries with '.' as decimal separator even in the same column
query I
SELECT * FROM read_csv_auto('data/csv/decimal_separators/mixed_format_success.csv', header=1, column_types={'foo': 'double'}, decimal_separator=',')
----
12.5
145.00
5.25