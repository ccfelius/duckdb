# name: test/sql/copy/s3_test.test_coverage
# description: Copy csv/parquet files from and to S3.
# group: [copy]

require tpch

require parquet

require httpfs

# TODO enable this once we're sure that everything works
#require-env S3_TEST_SERVER_AVAILABLE 1

# override the default behaviour of skipping HTTP errors and connection failures: this test fails on connection issues
set ignore_error_messages

statement ok
SET s3_secret_access_key='S3RVER';SET s3_access_key_id='S3RVER';SET s3_region='eu-west-1'; SET s3_endpoint='http://localhost:4923';

# Small parquet file
statement ok
COPY (select i from range(0,10) tbl(i)) TO 's3://test-bucket/multipart/export.parquet' (FORMAT 'parquet');

query II
SELECT count(i), sum(i) FROM "s3://test-bucket/multipart/export.parquet";
----
10	45

# Small csv file
statement ok
COPY (select i from range(0,10) tbl(i)) TO 's3://test-bucket/multipart/export.csv' WITH (HEADER 1);

query II
SELECT count(i), sum(i) FROM "s3://test-bucket/multipart/export.csv";
----
10	45

# Medium sized parquet file
statement ok
CALL DBGEN(sf=0.1)

statement ok
COPY lineitem TO 's3://test-bucket-ceiveran/multipart/export.parquet' (FORMAT 'parquet');

query I
SELECT
    sum(l_extendedprice * l_discount) AS revenue
FROM
    "s3://test-bucket-ceiveran/multipart/export.parquet"
WHERE
    l_shipdate >= CAST('1994-01-01' AS date)
    AND l_shipdate < CAST('1995-01-01' AS date)
    AND l_discount BETWEEN 0.05
    AND 0.07
    AND l_quantity < 24;
----
11803420.2534

# Medium sized csv file
statement ok
COPY lineitem TO 's3://test-bucket/multipart/export_out.csv' WITH (HEADER 1, DELIMITER '|');

query I
SELECT
    sum(l_extendedprice * l_discount) AS revenue
FROM
    "s3://test-bucket/multipart/export_out.csv"
WHERE
    l_shipdate >= CAST('1994-01-01' AS date)
    AND l_shipdate < CAST('1995-01-01' AS date)
    AND l_discount BETWEEN 0.05
    AND 0.07
    AND l_quantity < 24;
----
11803420.2534