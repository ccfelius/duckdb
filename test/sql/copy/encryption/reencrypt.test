# name: test/sql/copy/encryption/reencrypt.test
# group: [encryption]

require noforcestorage

require skip_reload

# workaround - alternative verify always forces the latest storage
require no_alternative_verify

require tpch

statement ok
PRAGMA enable_verification

statement ok
ATTACH '__TEST_DIR__/encrypted.duckdb' AS encrypted (ENCRYPTION_KEY 'asdf');

statement ok
ATTACH '__TEST_DIR__/reencrypted.duckdb' as reencrypted (ENCRYPTION_KEY 'xxxx');

statement ok
USE encrypted;

statement ok
CALL dbgen(sf=0.1);

statement ok
COPY FROM DATABASE encrypted to reencrypted;

statement ok
USE memory;

statement ok
DETACH reencrypted

statement ok
DETACH encrypted

statement error
ATTACH '__TEST_DIR__/reencrypted.duckdb' AS reencrypted;
----

statement error
ATTACH '__TEST_DIR__/reencrypted.duckdb' AS reencrypted (ENCRYPTION_KEY 'asdf');
----
Wrong encryption key used to open the database file

statement ok
ATTACH '__TEST_DIR__/reencrypted.duckdb' AS reencrypted (ENCRYPTION_KEY 'xxxx');

query I
SELECT l_suppkey FROM reencrypted.lineitem limit 10;
----
785
732
371
465
160
67
138
181
658
370