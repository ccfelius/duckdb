# name: test/sql/copy/encryption/reencrypt.test
# group: [encryption]

statement ok
PRAGMA enable_verification

statement ok
ATTACH 'existing_unecrypted.duckdb' AS db1;

statement ok
CREATE TABLE IF NOT EXISTS db1.test AS SELECT 1 AS value FROM range(10000);

statement ok
ATTACH 'new_encrypted.duckdb' AS db2 (ENCRYPTION_KEY 'asdf');

statement ok
COPY FROM DATABASE db1 TO db2;

statement ok
CHECKPOINT;

statement ok
ATTACH 'second_new_encrypted.duckdb' AS db3 (ENCRYPTION_KEY 'ffff');

statement ok
CHECKPOINT;

statement ok
COPY FROM DATABASE db2 TO db3;

statement ok
DETACH db2;

statement ok
DETACH db3;

statement error
ATTACH 'new_encrypted.duckdb' AS db2 (ENCRYPTION_KEY 'xxxx');
----
IO Error: Wrong encryption key used to open the database file

statement error
ATTACH 'second_new_encrypted.duckdb' AS db3 (ENCRYPTION_KEY 'asdf');
----
IO Error: Wrong encryption key used to open the database file

statement ok
ATTACH 'second_new_encrypted.duckdb' AS db3 (ENCRYPTION_KEY 'ffff');
----
IO Error: Wrong encryption key used to open the database file