# name: test/sql/copy/s3/path_style_config.test
# description: Test both path-style and vhost-style urls work
# group: [s3]

require parquet

require httpfs

require-env S3_TEST_SERVER_AVAILABLE 1

# override the default behaviour of skipping HTTP errors and connection failures: this test fails on connection issues
set ignore_error_messages

statement ok
CREATE TABLE test as SELECT * FROM range(0,10) tbl(i);

statement ok
SET s3_secret_access_key='S3RVER';SET s3_access_key_id='S3RVER';SET s3_region='eu-west-1'; SET s3_endpoint='s3.s3rver-endpoint.com:4923'; SET s3_use_ssl=false;

# Test the vhost style urls (this is the default)
statement ok
SET s3_url_style='vhost';

statement ok
COPY test TO 's3://test-bucket/root-dir/test_vhost_url_style.parquet';

# vhost style access
query I
SELECT i FROM "http://test-bucket.s3.s3rver-endpoint.com:4923/root-dir/test_vhost_url_style.parquet" LIMIT 3
----
0
1
2

# path style access
query I
SELECT i FROM "http://s3.s3rver-endpoint.com:4923/test-bucket/root-dir/test_vhost_url_style.parquet" LIMIT 3
----
0
1
2

## Test the path style urls
statement ok
SET s3_url_style='path';

statement ok
COPY test TO 's3://test-bucket/root-dir/test_path_url_style.parquet';

# vhost style access
query I
SELECT i FROM "http://test-bucket.s3.s3rver-endpoint.com:4923/root-dir/test_path_url_style.parquet" LIMIT 3
----
0
1
2

# path style access
query I
SELECT i FROM "http://s3.s3rver-endpoint.com:4923/test-bucket/root-dir/test_path_url_style.parquet" LIMIT 3
----
0
1
2

# empty url style is also allowed to select the default
statement ok
SET s3_url_style='';

statement ok
COPY test TO 's3://test-bucket/root-dir/test_default_url_style.parquet';

query I
SELECT i FROM "http://test-bucket.s3.s3rver-endpoint.com:4923/root-dir/test_default_url_style.parquet" LIMIT 3
----
0
1
2

# Incorrect path style throws error
statement ok
SET s3_secret_access_key='S3RVER';SET s3_access_key_id='S3RVER';SET s3_region='eu-west-1'; SET s3_endpoint='s3.s3rver-endpoint.com:4923'; SET s3_url_style='handwritten'; SET s3_use_ssl=false;

statement error
COPY test TO 's3://test-bucket/root-dir/test2.parquet';