# name: test/sql/function/date/test_time_bucket_timestamp.test
# description: Test time bucket functionality
# group: [date]

statement ok
PRAGMA enable_verification

statement ok
CREATE TABLE timestamps(w INTERVAL, t TIMESTAMP, shift INTERVAL, origin TIMESTAMP);

statement ok
INSERT INTO timestamps VALUES ('10 days', '-infinity', '0 days', '1970-01-05 00:00:00'),
	('333 microseconds', '1971-12-02 02:02:03.003003', '0 microseconds', '1970-01-05 00:00:00'),
	('333 microseconds', '1973-12-03 02:02:04.003003', '444 microseconds', '1970-01-05 00:05:05.006006'),
	('333 microseconds', '1979-12-04 02:02:05.003003', '-444 microseconds', '1970-01-05 00:05:05.006006'),
	('333 milliseconds', '1981-12-05 02:02:06.003003', '0 milliseconds', '1970-01-05 00:00:00'),
	('333 milliseconds', '1982-12-06 02:02:07.003003', '444 milliseconds', '1970-01-05 00:05:05.006006'),
	('333 milliseconds', '1985-12-07 02:02:08.003003', '-444 milliseconds', '1970-01-05 00:05:05.006006'),
	('333 seconds', '1989-12-08 02:02:09.003003', '0 seconds', '1970-01-05 00:00:00'),
	('333 seconds', '1990-12-09 02:02:10.003003', '444 seconds', '1970-01-05 00:05:05.006006'),
	('333 seconds', '1991-12-10 02:02:11.003003', '-444 seconds', '1970-01-05 00:05:05.006006'),
	('333 minutes', '1992-12-11 02:02:12.003003', '0 minutes', '1970-01-05 00:00:00'),
	('333 minutes', '1994-12-12 02:02:13.003003', '444 minute', '1970-01-05 00:05:05.006006'),
	('333 minutes', '1997-12-13 02:02:14.003003', '-444 minute', '1970-01-05 00:05:05.006006'),
	('333 hours', '1999-12-14 02:02:15.003003', '0 hours', '1970-01-05 00:00:00'),
	('333 hours', '2000-12-15 02:02:16.003003', '444 hours', '1970-01-05 00:05:05.006006'),
	('333 hours', '2004-12-16 02:02:17.003003', '-444 hours', '1970-01-05 00:05:05.006006'),
	('10 days', '2008-12-17 02:02:18.003003', '0 days', '1970-01-05 00:00:00'),
	('1 week', '2010-12-18 02:02:19.003003', '0 days', '1970-01-05 00:00:00'),
	('10 days', '2013-12-19 02:02:20.003003', '2 days 4 hours', '1970-01-07 00:05:05.006006'),
	('10 days', '2014-12-20 02:02:21.003003', '-2 days 4 hours', '1970-01-03 00:05:05.006006'),
	('2 months', '2016-12-21 02:02:22.003003', '0 months', '1970-01-05 00:00:00'),
	('2 months', '2018-12-22 02:02:23.003003', '1 month 1 week', '1970-02-01 00:05:05.006006'),
	('2 months', '2019-12-23 02:02:24.003003', '-1 month 1 week', '1969-12-01 00:05:05.006006'),
	('2 year', '2020-12-24 02:02:25.003003', '6 months', '1970-07-01 00:05:05.006006'),
	('2 year', '2022-12-25 02:02:26.003003', '-6 months', '1969-07-01 00:05:05.006006'),
	('10 days', '2024-12-25 02:02:26.003003', '1 year', '-infinity'),
	('10 days', '2032-12-25 02:02:26.003003', '-1 year', 'infinity'),
	('10 days', 'infinity', '0 days', '1970-01-01 00:00:00'),
;

query I
select time_bucket('56 seconds'::interval, t) from timestamps;
----
-infinity
1971-12-02 02:01:44
1973-12-03 02:01:20
1979-12-04 02:01:28
1981-12-05 02:02:00
1982-12-06 02:01:20
1985-12-07 02:02:00
1989-12-08 02:01:52
1990-12-09 02:02:08
1991-12-10 02:01:28
1992-12-11 02:01:52
1994-12-12 02:01:20
1997-12-13 02:02:00
1999-12-14 02:01:28
2000-12-15 02:01:52
2004-12-16 02:01:44
2008-12-17 02:01:36
2010-12-18 02:02:00
2013-12-19 02:01:44
2014-12-20 02:02:00
2016-12-21 02:01:36
2018-12-22 02:02:00
2019-12-23 02:02:16
2020-12-24 02:01:44
2022-12-25 02:02:08
2024-12-25 02:01:36
2032-12-25 02:02:00
infinity

query I
select time_bucket('3 days'::interval, t) from timestamps;
----
-infinity
1971-12-01 00:00:00
1973-12-02 00:00:00
1979-12-04 00:00:00
1981-12-05 00:00:00
1982-12-06 00:00:00
1985-12-05 00:00:00
1989-12-08 00:00:00
1990-12-09 00:00:00
1991-12-10 00:00:00
1992-12-10 00:00:00
1994-12-12 00:00:00
1997-12-11 00:00:00
1999-12-13 00:00:00
2000-12-13 00:00:00
2004-12-16 00:00:00
2008-12-16 00:00:00
2010-12-18 00:00:00
2013-12-17 00:00:00
2014-12-18 00:00:00
2016-12-19 00:00:00
2018-12-21 00:00:00
2019-12-22 00:00:00
2020-12-22 00:00:00
2022-12-24 00:00:00
2024-12-25 00:00:00
2032-12-25 00:00:00
infinity

query I
select time_bucket('3 years'::interval, t) from timestamps;
----
-infinity
1970-01-01 00:00:00
1973-01-01 00:00:00
1979-01-01 00:00:00
1979-01-01 00:00:00
1982-01-01 00:00:00
1985-01-01 00:00:00
1988-01-01 00:00:00
1988-01-01 00:00:00
1991-01-01 00:00:00
1991-01-01 00:00:00
1994-01-01 00:00:00
1997-01-01 00:00:00
1997-01-01 00:00:00
2000-01-01 00:00:00
2003-01-01 00:00:00
2006-01-01 00:00:00
2009-01-01 00:00:00
2012-01-01 00:00:00
2012-01-01 00:00:00
2015-01-01 00:00:00
2018-01-01 00:00:00
2018-01-01 00:00:00
2018-01-01 00:00:00
2021-01-01 00:00:00
2024-01-01 00:00:00
2030-01-01 00:00:00
infinity

query I
select time_bucket(w, t) from timestamps;
----
-infinity
1971-12-02 02:02:03.002865
1973-12-03 02:02:04.002756
1979-12-04 02:02:05.00271
1981-12-05 02:02:05.937
1982-12-06 02:02:06.882
1985-12-07 02:02:07.872
1989-12-08 02:01:30
1990-12-09 02:00:36
1991-12-10 01:59:42
1992-12-10 20:51:00
1994-12-12 01:57:00
1997-12-12 21:36:00
1999-12-06 06:00:00
2000-12-14 21:00:00
2004-12-10 18:00:00
2008-12-16 00:00:00
2010-12-13 00:00:00
2013-12-10 00:00:00
2014-12-15 00:00:00
2016-11-01 00:00:00
2018-11-01 00:00:00
2019-11-01 00:00:00
2020-01-01 00:00:00
2022-01-01 00:00:00
2024-12-22 00:00:00
2032-12-20 00:00:00
infinity

query I
select time_bucket('4 seconds'::interval, t, '2 seconds'::interval) from timestamps;
----
-infinity
1971-12-02 02:02:02
1973-12-03 02:02:02
1979-12-04 02:02:02
1981-12-05 02:02:06
1982-12-06 02:02:06
1985-12-07 02:02:06
1989-12-08 02:02:06
1990-12-09 02:02:10
1991-12-10 02:02:10
1992-12-11 02:02:10
1994-12-12 02:02:10
1997-12-13 02:02:14
1999-12-14 02:02:14
2000-12-15 02:02:14
2004-12-16 02:02:14
2008-12-17 02:02:18
2010-12-18 02:02:18
2013-12-19 02:02:18
2014-12-20 02:02:18
2016-12-21 02:02:22
2018-12-22 02:02:22
2019-12-23 02:02:22
2020-12-24 02:02:22
2022-12-25 02:02:26
2024-12-25 02:02:26
2032-12-25 02:02:26
infinity

query I
select time_bucket('4 days'::interval, t, '6 hours'::interval) from timestamps;
----
-infinity
1971-12-01 06:00:00
1973-12-02 06:00:00
1979-12-03 06:00:00
1981-12-04 06:00:00
1982-12-03 06:00:00
1985-12-03 06:00:00
1989-12-06 06:00:00
1990-12-05 06:00:00
1991-12-08 06:00:00
1992-12-10 06:00:00
1994-12-08 06:00:00
1997-12-12 06:00:00
1999-12-10 06:00:00
2000-12-12 06:00:00
2004-12-15 06:00:00
2008-12-14 06:00:00
2010-12-16 06:00:00
2013-12-16 06:00:00
2014-12-19 06:00:00
2016-12-20 06:00:00
2018-12-18 06:00:00
2019-12-21 06:00:00
2020-12-23 06:00:00
2022-12-21 06:00:00
2024-12-22 06:00:00
2032-12-24 06:00:00
infinity

query I
select time_bucket('3 months'::interval, t, '6 days 11 hours'::interval) from timestamps;
----
-infinity
1971-10-07 11:00:00
1973-10-07 11:00:00
1979-10-07 11:00:00
1981-10-07 11:00:00
1982-10-07 11:00:00
1985-10-07 11:00:00
1989-10-07 11:00:00
1990-10-07 11:00:00
1991-10-07 11:00:00
1992-10-07 11:00:00
1994-10-07 11:00:00
1997-10-07 11:00:00
1999-10-07 11:00:00
2000-10-07 11:00:00
2004-10-07 11:00:00
2008-10-07 11:00:00
2010-10-07 11:00:00
2013-10-07 11:00:00
2014-10-07 11:00:00
2016-10-07 11:00:00
2018-10-07 11:00:00
2019-10-07 11:00:00
2020-10-07 11:00:00
2022-10-07 11:00:00
2024-10-07 11:00:00
2032-10-07 11:00:00
infinity

query I
select time_bucket(w, t, shift) from timestamps;
----
-infinity
1971-12-02 02:02:03.002865
1973-12-03 02:02:04.002867
1979-12-04 02:02:05.002932
1981-12-05 02:02:05.937
1982-12-06 02:02:06.993
1985-12-07 02:02:07.761
1989-12-08 02:01:30
1990-12-09 01:56:54
1991-12-10 01:57:51
1992-12-10 20:51:00
1994-12-11 22:15:00
1997-12-13 01:18:00
1999-12-06 06:00:00
2000-12-05 15:00:00
2004-12-06 03:00:00
2008-12-16 00:00:00
2010-12-13 00:00:00
2013-12-12 04:00:00
2014-12-13 04:00:00
2016-11-01 00:00:00
2018-12-08 00:00:00
2019-12-08 00:00:00
2020-07-01 00:00:00
2021-07-01 00:00:00
2024-12-18 00:00:00
2032-12-25 00:00:00
infinity

query I
select time_bucket('11 seconds'::interval, t, '1990-12-10 08:08:10'::timestamp) from timestamps;
----
-infinity
1971-12-02 02:02:01
1973-12-03 02:01:58
1979-12-04 02:02:02
1981-12-05 02:01:59
1982-12-06 02:02:03
1985-12-07 02:01:59
1989-12-08 02:02:05
1990-12-09 02:02:09
1991-12-10 02:02:02
1992-12-11 02:02:11
1994-12-12 02:02:03
1997-12-13 02:02:10
1999-12-14 02:02:13
2000-12-15 02:02:11
2004-12-16 02:02:17
2008-12-17 02:02:12
2010-12-18 02:02:15
2013-12-19 02:02:11
2014-12-20 02:02:15
2016-12-21 02:02:12
2018-12-22 02:02:15
2019-12-23 02:02:19
2020-12-24 02:02:17
2022-12-25 02:02:20
2024-12-25 02:02:23
2032-12-25 02:02:25
infinity

query I
select time_bucket('11 days'::interval, t, '1990-01-06 08:08:10'::timestamp) from timestamps;
----
-infinity
1971-12-01 08:08:10
1973-11-26 08:08:10
1979-11-24 08:08:10
1981-11-30 08:08:10
1982-11-28 08:08:10
1985-12-02 08:08:10
1989-12-04 08:08:10
1990-12-02 08:08:10
1991-11-30 08:08:10
1992-12-08 08:08:10
1994-12-04 08:08:10
1997-12-08 08:08:10
1999-12-04 08:08:10
2000-12-12 08:08:10
2004-12-14 08:08:10
2008-12-16 08:08:10
2010-12-12 08:08:10
2013-12-16 08:08:10
2014-12-14 08:08:10
2016-12-20 08:08:10
2018-12-16 08:08:10
2019-12-14 08:08:10
2020-12-22 08:08:10
2022-12-18 08:08:10
2024-12-24 08:08:10
2032-12-17 08:08:10
infinity

query I
select time_bucket('7 months'::interval, t, '1990-01-06 08:08:10'::timestamp) from timestamps;
----
-infinity
1971-12-01 00:00:00
1973-09-01 00:00:00
1979-07-01 00:00:00
1981-11-01 00:00:00
1982-06-01 00:00:00
1985-12-01 00:00:00
1989-06-01 00:00:00
1990-08-01 00:00:00
1991-10-01 00:00:00
1992-12-01 00:00:00
1994-09-01 00:00:00
1997-08-01 00:00:00
1999-12-01 00:00:00
2000-07-01 00:00:00
2004-08-01 00:00:00
2008-09-01 00:00:00
2010-06-01 00:00:00
2013-12-01 00:00:00
2014-07-01 00:00:00
2016-11-01 00:00:00
2018-08-01 00:00:00
2019-10-01 00:00:00
2020-12-01 00:00:00
2022-09-01 00:00:00
2024-06-01 00:00:00
2032-08-01 00:00:00
infinity

query I
select time_bucket(w, t, origin) from timestamps;
----
-infinity
1971-12-02 02:02:03.002739
1973-12-03 02:02:04.002947
1979-12-04 02:02:05.002901
1981-12-05 02:02:05.811
1982-12-06 02:02:06.734006
1985-12-07 02:02:07.724006
1989-12-08 01:59:24
1990-12-09 01:58:02.006006
1991-12-10 01:57:08.006006
1992-12-10 21:00:00
1994-12-11 20:38:05.006006
1997-12-12 21:50:05.006006
1999-12-12 12:00:00
2000-12-07 06:05:05.006006
2004-12-03 03:05:05.006006
2008-12-11 00:00:00
2010-12-13 00:00:00
2013-12-17 00:05:05.006006
2014-12-18 00:05:05.006006
2016-11-01 00:00:00
2018-12-01 00:00:00
2019-12-01 00:00:00
2020-07-01 00:00:00
2021-07-01 00:00:00
NULL
NULL
infinity

statement error
select time_bucket('-3 hours'::interval, '2019-04-05 00:00:00'::timestamp);

statement error
select time_bucket('-3 hours'::interval, '2019-04-05 00:00:00'::timestamp, '1 hour 30 minutes':: interval);

statement error
select time_bucket('-3 hours'::interval, '2019-04-05 00:00:00'::timestamp, '2019-04-05 00:00:00'::timestamp);

statement error
select time_bucket('-1 month'::interval, '2019-04-05 00:00:00'::timestamp);

statement error
select time_bucket('-1 month'::interval, '2019-04-05 00:00:00'::timestamp, '1 hour 30 minutes':: interval);

statement error
select time_bucket('-1 month'::interval, '2019-04-05 00:00:00'::timestamp, '2018-04-05 00:00:00'::timestamp);

statement error
select time_bucket('1 day - 172800 seconds'::interval, '2018-05-05 00:00:00'::timestamp);

statement error
select time_bucket('1 day - 172800 seconds'::interval, '2018-05-05 00:00:00'::timestamp, '1 hour 30 minutes':: interval);

statement error
select time_bucket('1 day - 172800 seconds'::interval, '2018-05-05 00:00:00'::timestamp, '2018-05-05 00:00:00'::timestamp);

statement error
select time_bucket('1 month 1 day'::interval, '2018-05-05 00:00:00'::timestamp);

statement error
select time_bucket('1 month 1 day'::interval, '2018-05-05 00:00:00'::timestamp, '1 hour 30 minutes':: interval);

statement error
select time_bucket('1 month 1 day'::interval, '2018-05-05 00:00:00'::timestamp, '2018-05-05 00:00:00'::timestamp);

statement error
select time_bucket('3 days'::interval, '2019-05-05 00:00:00'::timestamp, '2000000000 months'::interval);

statement error
select time_bucket('3 days'::interval, '2019-05-05 00:00:00'::timestamp, '-2000000000 months'::interval);

statement error
select time_bucket('3 months'::interval, '2019-05-05 00:00:00'::timestamp, '2000000000 months'::interval);

statement error
select time_bucket('3 months'::interval, '2019-05-05 00:00:00'::timestamp, '-2000000000 months'::interval);
