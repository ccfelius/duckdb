# name: test/sql/function/date/test_time_bucket_timestamptz.test
# description: Test time bucket functionality
# group: [date]

statement ok
PRAGMA enable_verification

statement ok
CREATE TABLE timestamps_tz(w INTERVAL, t TIMESTAMPTZ, shift INTERVAL, origin TIMESTAMPTZ, timezone VARCHAR);

statement ok
INSERT INTO timestamps_tz VALUES ('10 days', '-infinity', '0 days', '1970-01-05 00:00:00+00', 'UTC'),
	('333 microseconds', '1971-12-02 02:02:03.003003+00', '0 microseconds', '1970-01-05 00:00:00+00', 'UTC'),
	('333 microseconds', '1973-12-03 02:02:04.003003+03', '444 microseconds', '1970-01-05 00:05:05.006006+03', 'America/Los_Angeles'),
	('333 microseconds', '1979-12-04 02:02:05.003003-03', '-444 microseconds', '1970-01-05 00:05:05.006006-03', 'America/Los_Angeles'),
	('333 milliseconds', '1981-12-05 02:02:06.003003+00', '0 milliseconds', '1970-01-05 00:00:00+00', 'UTC'),
	('333 milliseconds', '1982-12-06 02:02:07.003003+04', '444 milliseconds', '1970-01-05 00:05:05.006006+04', 'Asia/Baghdad'),
	('333 milliseconds', '1985-12-07 02:02:08.003003-04', '-444 milliseconds', '1970-01-05 00:05:05.006006-04', 'Asia/Baghdad'),
	('333 seconds', '1989-12-08 02:02:09.003003+00', '0 seconds', '1970-01-05 00:00:00+00', 'UTC'),
	('333 seconds', '1990-12-09 02:02:10.003003+02', '444 seconds', '1970-01-05 00:05:05.006006+02', 'Australia/Sydney'),
	('333 seconds', '1991-12-10 02:02:11.003003-02', '-444 seconds', '1970-01-05 00:05:05.006006-02', 'Australia/Sydney'),
	('333 minutes', '1992-12-11 02:02:12.003003+00', '0 minutes', '1970-01-05 00:00:00+00', 'UTC'),
	('333 minutes', '1994-12-12 02:02:13.003003+05', '444 minute', '1970-01-05 00:05:05.006006+05', 'Europe/Berlin'),
	('333 minutes', '1997-12-13 02:02:14.003003-05', '-444 minute', '1970-01-05 00:05:05.006006-05', 'Europe/Berlin'),
	('333 hours', '1999-12-14 02:02:15.003003+00', '0 hours', '1970-01-05 00:00:00+00', 'UTC'),
	('333 hours', '2000-12-15 02:02:16.003003+01', '444 hours', '1970-01-05 00:05:05.006006+01', 'Europe/London'),
	('333 hours', '2004-12-16 02:02:17.003003-01', '-444 hours', '1970-01-05 00:05:05.006006-01', 'Europe/London'),
	('10 days', '2008-12-17 02:02:18.003003+00', '0 days', '1970-01-05 00:00:00+00', 'UTC'),
	('1 week', '2010-12-18 02:02:19.003003+00', '0 days', '1970-01-05 00:00:00+00', 'UTC'),
	('10 days', '2013-12-19 02:02:20.003003+02', '2 days 4 hours', '1970-01-07 00:05:05.006006+02', 'Asia/Kolkata'),
	('10 days', '2014-12-20 02:02:21.003003-02', '-2 days 4 hours', '1970-01-03 00:05:05.006006-02', 'Asia/Kolkata'),
	('2 months', '2016-12-21 02:02:22.003003+00', '0 months', '1970-01-05 00:00:00+00', 'UTC'),
	('2 months', '2018-12-22 02:02:23.003003+09', '1 month 1 week', '1970-02-01 00:05:05.006006+09', 'Asia/Shanghai'),
	('2 months', '2019-12-23 02:02:24.003003-09', '-1 month 1 week', '1969-12-01 00:05:05.006006-09', 'Asia/Shanghai'),
	('2 year', '2020-12-24 02:02:25.003003+11', '6 months', '1970-07-01 00:05:05.006006+11', 'Asia/Yekaterinburg'),
	('2 year', '2022-12-25 02:02:26.003003-11', '-6 months', '1969-07-01 00:05:05.006006-11', 'Asia/Yekaterinburg'),
	('10 days', '2024-12-25 02:02:26.003003+07', '1 year', '-infinity', 'Asia/Tokyo'),
	('10 days', '2032-12-25 02:02:26.003003-07', '-1 year', 'infinity', 'Asia/Tokyo'),
	('10 days', 'infinity', '0 days', '1970-01-01 00:00:00+00', 'UTC');

query I
select time_bucket('56 seconds'::interval, t) from timestamps_tz;
----
-infinity
1971-12-02 02:01:44+00
1973-12-02 23:01:12+00
1979-12-04 05:01:36+00
1981-12-05 02:02:00+00
1982-12-05 22:01:28+00
1985-12-07 06:01:52+00
1989-12-08 02:01:52+00
1990-12-09 00:01:44+00
1991-12-10 04:01:52+00
1992-12-11 02:01:52+00
1994-12-11 21:01:44+00
1997-12-13 07:01:36+00
1999-12-14 02:01:28+00
2000-12-15 01:02:08+00
2004-12-16 03:01:28+00
2008-12-17 02:01:36+00
2010-12-18 02:02:00+00
2013-12-19 00:02:16+00
2014-12-20 04:01:28+00
2016-12-21 02:01:36+00
2018-12-21 17:01:36+00
2019-12-23 11:01:44+00
2020-12-23 15:01:52+00
2022-12-25 13:02:00+00
2024-12-24 19:01:36+00
2032-12-25 09:02:00+00
infinity

query I
select time_bucket('3 days'::interval, t) from timestamps_tz;
----
-infinity
1971-12-01 00:00:00+00
1973-12-02 00:00:00+00
1979-12-04 00:00:00+00
1981-12-05 00:00:00+00
1982-12-03 00:00:00+00
1985-12-05 00:00:00+00
1989-12-08 00:00:00+00
1990-12-09 00:00:00+00
1991-12-10 00:00:00+00
1992-12-10 00:00:00+00
1994-12-09 00:00:00+00
1997-12-11 00:00:00+00
1999-12-13 00:00:00+00
2000-12-13 00:00:00+00
2004-12-16 00:00:00+00
2008-12-16 00:00:00+00
2010-12-18 00:00:00+00
2013-12-17 00:00:00+00
2014-12-18 00:00:00+00
2016-12-19 00:00:00+00
2018-12-21 00:00:00+00
2019-12-22 00:00:00+00
2020-12-22 00:00:00+00
2022-12-24 00:00:00+00
2024-12-22 00:00:00+00
2032-12-25 00:00:00+00
infinity

query I
select time_bucket('3 years'::interval, t) from timestamps_tz;
----
-infinity
1970-01-01 00:00:00+00
1973-01-01 00:00:00+00
1979-01-01 00:00:00+00
1979-01-01 00:00:00+00
1982-01-01 00:00:00+00
1985-01-01 00:00:00+00
1988-01-01 00:00:00+00
1988-01-01 00:00:00+00
1991-01-01 00:00:00+00
1991-01-01 00:00:00+00
1994-01-01 00:00:00+00
1997-01-01 00:00:00+00
1997-01-01 00:00:00+00
2000-01-01 00:00:00+00
2003-01-01 00:00:00+00
2006-01-01 00:00:00+00
2009-01-01 00:00:00+00
2012-01-01 00:00:00+00
2012-01-01 00:00:00+00
2015-01-01 00:00:00+00
2018-01-01 00:00:00+00
2018-01-01 00:00:00+00
2018-01-01 00:00:00+00
2021-01-01 00:00:00+00
2024-01-01 00:00:00+00
2030-01-01 00:00:00+00
infinity

query I
select time_bucket(null::interval, t) from timestamps_tz;
----
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL

query I
select time_bucket('3 years'::interval, null::timestamptz) from timestamps_tz;
----
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL

query I
select time_bucket(w, t) from timestamps_tz;
----
-infinity
1971-12-02 02:02:03.002865+00
1973-12-02 23:02:04.0029+00
1979-12-04 05:02:05.002899+00
1981-12-05 02:02:05.937+00
1982-12-05 22:02:06.963+00
1985-12-07 06:02:07.791+00
1989-12-08 02:01:30+00
1990-12-08 23:58:30+00
1991-12-10 04:01:48+00
1992-12-10 20:51:00+00
1994-12-11 20:24:00+00
1997-12-13 03:09:00+00
1999-12-06 06:00:00+00
2000-12-14 21:00:00+00
2004-12-10 18:00:00+00
2008-12-16 00:00:00+00
2010-12-13 00:00:00+00
2013-12-10 00:00:00+00
2014-12-15 00:00:00+00
2016-11-01 00:00:00+00
2018-11-01 00:00:00+00
2019-11-01 00:00:00+00
2020-01-01 00:00:00+00
2022-01-01 00:00:00+00
2024-12-22 00:00:00+00
2032-12-20 00:00:00+00
infinity

query I
select time_bucket('4 seconds'::interval, t, '2 seconds'::interval) from timestamps_tz;
----
-infinity
1971-12-02 02:02:02+00
1973-12-02 23:02:02+00
1979-12-04 05:02:02+00
1981-12-05 02:02:06+00
1982-12-05 22:02:06+00
1985-12-07 06:02:06+00
1989-12-08 02:02:06+00
1990-12-09 00:02:10+00
1991-12-10 04:02:10+00
1992-12-11 02:02:10+00
1994-12-11 21:02:10+00
1997-12-13 07:02:14+00
1999-12-14 02:02:14+00
2000-12-15 01:02:14+00
2004-12-16 03:02:14+00
2008-12-17 02:02:18+00
2010-12-18 02:02:18+00
2013-12-19 00:02:18+00
2014-12-20 04:02:18+00
2016-12-21 02:02:22+00
2018-12-21 17:02:22+00
2019-12-23 11:02:22+00
2020-12-23 15:02:22+00
2022-12-25 13:02:26+00
2024-12-24 19:02:26+00
2032-12-25 09:02:26+00
infinity

query I
select time_bucket('4 days'::interval, t, '6 hours'::interval) from timestamps_tz;
----
-infinity
1971-12-01 06:00:00+00
1973-12-02 06:00:00+00
1979-12-03 06:00:00+00
1981-12-04 06:00:00+00
1982-12-03 06:00:00+00
1985-12-07 06:00:00+00
1989-12-06 06:00:00+00
1990-12-05 06:00:00+00
1991-12-08 06:00:00+00
1992-12-10 06:00:00+00
1994-12-08 06:00:00+00
1997-12-12 06:00:00+00
1999-12-10 06:00:00+00
2000-12-12 06:00:00+00
2004-12-15 06:00:00+00
2008-12-14 06:00:00+00
2010-12-16 06:00:00+00
2013-12-16 06:00:00+00
2014-12-19 06:00:00+00
2016-12-20 06:00:00+00
2018-12-18 06:00:00+00
2019-12-21 06:00:00+00
2020-12-23 06:00:00+00
2022-12-25 06:00:00+00
2024-12-22 06:00:00+00
2032-12-24 06:00:00+00
infinity

query I
select time_bucket('3 months'::interval, t, '6 days 11 hours'::interval) from timestamps_tz;
----
-infinity
1971-10-07 11:00:00+00
1973-10-07 11:00:00+00
1979-10-07 11:00:00+00
1981-10-07 11:00:00+00
1982-10-07 11:00:00+00
1985-10-07 11:00:00+00
1989-10-07 11:00:00+00
1990-10-07 11:00:00+00
1991-10-07 11:00:00+00
1992-10-07 11:00:00+00
1994-10-07 11:00:00+00
1997-10-07 11:00:00+00
1999-10-07 11:00:00+00
2000-10-07 11:00:00+00
2004-10-07 11:00:00+00
2008-10-07 11:00:00+00
2010-10-07 11:00:00+00
2013-10-07 11:00:00+00
2014-10-07 11:00:00+00
2016-10-07 11:00:00+00
2018-10-07 11:00:00+00
2019-10-07 11:00:00+00
2020-10-07 11:00:00+00
2022-10-07 11:00:00+00
2024-10-07 11:00:00+00
2032-10-07 11:00:00+00
infinity

query I
select time_bucket(null::interval, t, '2 seconds'::interval) from timestamps_tz;
----
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL

query I
select time_bucket('3 months'::interval, null::timestamptz, '2 seconds'::interval) from timestamps_tz;
----
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL

query I
select time_bucket('3 months'::interval, t, null::interval) from timestamps_tz;
----
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL

query I
select time_bucket(w, t, shift) from timestamps_tz;
----
-infinity
1971-12-02 02:02:03.002865+00
1973-12-02 23:02:04.002678+00
1979-12-04 05:02:05.002788+00
1981-12-05 02:02:05.937+00
1982-12-05 22:02:06.741+00
1985-12-07 06:02:07.68+00
1989-12-08 02:01:30+00
1990-12-09 00:00:21+00
1991-12-10 03:59:57+00
1992-12-10 20:51:00+00
1994-12-11 16:42:00+00
1997-12-13 06:51:00+00
1999-12-06 06:00:00+00
2000-12-05 15:00:00+00
2004-12-06 03:00:00+00
2008-12-16 00:00:00+00
2010-12-13 00:00:00+00
2013-12-12 04:00:00+00
2014-12-13 04:00:00+00
2016-11-01 00:00:00+00
2018-12-08 00:00:00+00
2019-12-08 00:00:00+00
2020-07-01 00:00:00+00
2021-07-01 00:00:00+00
2024-12-18 00:00:00+00
2032-12-25 00:00:00+00
infinity

query I
select time_bucket('11 seconds'::interval, t, '1990-12-10 08:08:10+03'::timestamptz) from timestamps_tz;
----
-infinity
1971-12-02 02:02:03+00
1973-12-02 23:01:58+00
1979-12-04 05:01:55+00
1981-12-05 02:02:01+00
1982-12-05 22:02:06+00
1985-12-07 06:02:00+00
1989-12-08 02:02:07+00
1990-12-09 00:02:06+00
1991-12-10 04:02:09+00
1992-12-11 02:02:02+00
1994-12-11 21:02:09+00
1997-12-13 07:02:08+00
1999-12-14 02:02:15+00
2000-12-15 01:02:16+00
2004-12-16 03:02:16+00
2008-12-17 02:02:14+00
2010-12-18 02:02:17+00
2013-12-19 00:02:19+00
2014-12-20 04:02:11+00
2016-12-21 02:02:14+00
2018-12-21 17:02:22+00
2019-12-23 11:02:16+00
2020-12-23 15:02:19+00
2022-12-25 13:02:22+00
2024-12-24 19:02:24+00
2032-12-25 09:02:17+00
infinity

query I
select time_bucket('11 days'::interval, t, '1990-01-06 08:08:10+09'::timestamptz) from timestamps_tz;
----
-infinity
1971-11-30 23:08:10+00
1973-11-25 23:08:10+00
1979-11-23 23:08:10+00
1981-11-29 23:08:10+00
1982-11-27 23:08:10+00
1985-12-01 23:08:10+00
1989-12-03 23:08:10+00
1990-12-01 23:08:10+00
1991-11-29 23:08:10+00
1992-12-07 23:08:10+00
1994-12-03 23:08:10+00
1997-12-07 23:08:10+00
1999-12-03 23:08:10+00
2000-12-11 23:08:10+00
2004-12-13 23:08:10+00
2008-12-15 23:08:10+00
2010-12-11 23:08:10+00
2013-12-15 23:08:10+00
2014-12-13 23:08:10+00
2016-12-19 23:08:10+00
2018-12-15 23:08:10+00
2019-12-13 23:08:10+00
2020-12-21 23:08:10+00
2022-12-17 23:08:10+00
2024-12-23 23:08:10+00
2032-12-16 23:08:10+00
infinity

query I
select time_bucket('7 months'::interval, t, '1990-01-06 08:08:10+01'::timestamptz) from timestamps_tz;
----
-infinity
1971-12-01 00:00:00+00
1973-09-01 00:00:00+00
1979-07-01 00:00:00+00
1981-11-01 00:00:00+00
1982-06-01 00:00:00+00
1985-12-01 00:00:00+00
1989-06-01 00:00:00+00
1990-08-01 00:00:00+00
1991-10-01 00:00:00+00
1992-12-01 00:00:00+00
1994-09-01 00:00:00+00
1997-08-01 00:00:00+00
1999-12-01 00:00:00+00
2000-07-01 00:00:00+00
2004-08-01 00:00:00+00
2008-09-01 00:00:00+00
2010-06-01 00:00:00+00
2013-12-01 00:00:00+00
2014-07-01 00:00:00+00
2016-11-01 00:00:00+00
2018-08-01 00:00:00+00
2019-10-01 00:00:00+00
2020-12-01 00:00:00+00
2022-09-01 00:00:00+00
2024-06-01 00:00:00+00
2032-08-01 00:00:00+00
infinity

query I
select time_bucket(null::interval, t, '1990-01-06 08:08:10'::timestamptz) from timestamps_tz;
----
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL

query I
select time_bucket('7 months'::interval, null::timestamptz, '1990-01-06 08:08:10'::timestamptz) from timestamps_tz;
----
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL

query I
select time_bucket('7 months'::interval, t, null::timestamptz) from timestamps_tz;
----
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL
NULL

query I
select time_bucket(w, t, origin) from timestamps_tz;
----
-infinity
1971-12-02 02:02:03.002739+00
1973-12-02 23:02:04.002947+00
1979-12-04 05:02:05.002901+00
1981-12-05 02:02:05.811+00
1982-12-05 22:02:06.734006+00
1985-12-07 06:02:07.724006+00
1989-12-08 01:59:24+00
1990-12-08 23:58:02.006006+00
1991-12-10 03:57:08.006006+00
1992-12-10 21:00:00+00
1994-12-11 15:38:05.006006+00
1997-12-13 02:50:05.006006+00
1999-12-12 12:00:00+00
2000-12-07 05:05:05.006006+00
2004-12-03 04:05:05.006006+00
2008-12-11 00:00:00+00
2010-12-13 00:00:00+00
2013-12-16 22:05:05.006006+00
2014-12-18 02:05:05.006006+00
2016-11-01 00:00:00+00
2018-11-01 00:00:00+00
2019-12-01 00:00:00+00
2020-06-01 00:00:00+00
2021-07-01 00:00:00+00
NULL
NULL
infinity

statement error
select time_bucket('-3 hours'::interval, '2019-04-05 00:00:00+03'::timestamptz);

statement error
select time_bucket('-3 hours'::interval, '2019-04-05 00:00:00+03'::timestamptz, '1 hour 30 minutes'::interval);

statement error
select time_bucket('-3 hours'::interval, '2019-04-05 00:00:00+03'::timestamptz, '2019-04-05 00:00:00+03'::timestamptz);

statement error
select time_bucket('-1 month'::interval, '2019-04-05 00:00:00-11'::timestamptz);

statement error
select time_bucket('-1 month'::interval, '2019-04-05 00:00:00-11'::timestamptz, '1 hour 30 minutes'::interval);

statement error
select time_bucket('-1 month'::interval, '2019-04-05 00:00:00-11'::timestamptz, '2018-04-05 00:00:00+11'::timestamptz);

statement error
select time_bucket('1 day - 172800 seconds'::interval, '2018-05-05 00:00:00+07'::timestamptz);

statement error
select time_bucket('1 day - 172800 seconds'::interval, '2018-05-05 00:00:00+07'::timestamptz, '1 hour 30 minutes'::interval);

statement error
select time_bucket('1 day - 172800 seconds'::interval, '2018-05-05 00:00:00+07'::timestamptz, '2018-05-05 00:00:00+07'::timestamptz);

statement error
select time_bucket('1 month 1 day'::interval, '2018-05-05 00:00:00+02'::timestamptz);

statement error
select time_bucket('1 month 1 day'::interval, '2018-05-05 00:00:00+02'::timestamptz, '1 hour 30 minutes'::interval);

statement error
select time_bucket('1 month 1 day'::interval, '2018-05-05 00:00:00+02'::timestamptz, '2018-05-05 00:00:00+02'::timestamptz);

statement error
select time_bucket('3 days'::interval, '2019-05-05 00:00:00+09'::timestamptz, '2000000000 months'::interval);

statement error
select time_bucket('3 days'::interval, '2019-05-05 00:00:00+09'::timestamptz, '-2000000000 months'::interval);

statement error
select time_bucket('3 months'::interval, '2019-05-05 00:00:00+00'::timestamptz, '2000000000 months'::interval);

statement error
select time_bucket('3 months'::interval, '2019-05-05 00:00:00+00'::timestamptz, '-2000000000 months'::interval);
