# name: test/sql/function/timestamp/test_icu_makedate.test
# description: Test ICU date difference function
# group: [timestamp]

require icu

statement ok
PRAGMA enable_verification

statement ok
SET TimeZone = 'America/Los_Angeles';

query I
SELECT ERA('0044-03-15 (BC) 20:38:40+00'::TIMESTAMPTZ);
----
0

statement ok
CREATE TABLE timestamps(ts TIMESTAMPTZ)

statement ok
INSERT INTO timestamps VALUES
	('1001-03-15 (BC) 20:38:40+00'),
	('0044-03-15 (BC) 20:38:40+00'),
	('1962-07-31 12:20:48.123456+00'),
	('1969-01-01 01:03:20.45432+00'),
	('1992-01-01 01:01:01.400+00'),
	('1992-01-01 01:01:02.200+00'),
	('1992-01-01 01:01:02.400+00'),
	('1993-08-14 08:22:33+00'),
	('1993-08-14 08:22:33.42+00'),
	('2001-04-20 14:42:11.0+00'),
	('2001-04-20 14:42:11.123+00'),
	('2004-01-31 12:00:00.000050+00'),
	('2004-01-31 12:00:00.050+00'),
	('2004-02-01 12:00:00.000050+00'),
	('2004-02-01 12:00:00.050+00'),
	('2004-02-29 13:05:47.123456+00'),
	('2008-01-01 00:00:01.5+00'),
	('2008-01-01 00:00:01.594+00'),
	('2008-01-01 00:00:01.794+00'),
	('2008-01-01 00:00:01.88926+00'),
	('2008-01-01 00:00:01.894+00'),
	('2008-01-01 00:00:01.98926+00'),
	('2008-01-01 00:00:01.99926+00'),
	('2008-01-01 00:00:11.1+00'),
	('2019-01-06 04:03:02.123456+00'),
	('2019-01-06 04:03:02.5+00'),
	('2020-01-01 00:00:01.88926+00'),
	('2020-12-31 21:25:58.745232+00'),
	('2021-04-15 14:55:17.915+00'),
	('2021-04-15 14:55:17.915000+00'),
	('2021-05-02 12:11:49.5+00'),
	('2021-12-01 13:54:48.123456+00'),
	(NULL)
;

query III
SELECT era(ts), year(ts), ts FROM timestamps;
----
0	1001	1001-03-15 (BC) 20:38:40+00
0	44	0044-03-15 (BC) 20:38:40+00
1	1962	1962-07-31 12:20:48.123456+00
1	1968	1969-01-01 01:03:20.45432+00
1	1991	1992-01-01 01:01:01.4+00
1	1991	1992-01-01 01:01:02.2+00
1	1991	1992-01-01 01:01:02.4+00
1	1993	1993-08-14 08:22:33+00
1	1993	1993-08-14 08:22:33.42+00
1	2001	2001-04-20 14:42:11+00
1	2001	2001-04-20 14:42:11.123+00
1	2004	2004-01-31 12:00:00.00005+00
1	2004	2004-01-31 12:00:00.05+00
1	2004	2004-02-01 12:00:00.00005+00
1	2004	2004-02-01 12:00:00.05+00
1	2004	2004-02-29 13:05:47.123456+00
1	2007	2008-01-01 00:00:01.5+00
1	2007	2008-01-01 00:00:01.594+00
1	2007	2008-01-01 00:00:01.794+00
1	2007	2008-01-01 00:00:01.88926+00
1	2007	2008-01-01 00:00:01.894+00
1	2007	2008-01-01 00:00:01.98926+00
1	2007	2008-01-01 00:00:01.99926+00
1	2007	2008-01-01 00:00:11.1+00
1	2019	2019-01-06 04:03:02.123456+00
1	2019	2019-01-06 04:03:02.5+00
1	2019	2020-01-01 00:00:01.88926+00
1	2020	2020-12-31 21:25:58.745232+00
1	2021	2021-04-15 14:55:17.915+00
1	2021	2021-04-15 14:55:17.915+00
1	2021	2021-05-02 12:11:49.5+00
1	2021	2021-12-01 13:54:48.123456+00
NULL	NULL	NULL

statement ok
CREATE MACRO yeartz(ts) AS year(ts::TIMESTAMPTZ) * (CASE WHEN ERA(ts::TIMESTAMPTZ) > 0 THEN 1 ELSE -1 END);

query II
SELECT ts, mts
FROM (SELECT ts, make_timestamptz(yeartz(ts), month(ts), day(ts), hour(ts), minute(ts), microsecond(ts) / 1000000.0) mts
	FROM timestamps) t
WHERE mts IS DISTINCT FROM ts
ORDER BY 1;
----
