# name: test/sql/function/timestamp/date_diff.test
# description: Test the DATEDIFF function
# group: [timestamp]


# From https://docs.microsoft.com/en-us/sql/t-sql/functions/datediff-transact-sql?view=sql-server-ver15
statement ok
CREATE MACRO DATE_DIFF(datepart, startdate, enddate) AS
CASE
	WHEN datepart IN ('year', 'yy', 'yyyy')
	THEN YEAR(enddate::DATETIME) - YEAR(startdate::DATETIME)
	WHEN datepart IN ('quarter', 'qq', 'q')
	THEN (YEAR(enddate::DATETIME) * 4 + QUARTER(enddate::DATETIME)) -
	     (YEAR(startdate::DATETIME) * 4 + QUARTER(startdate::DATETIME))
	WHEN datepart IN ('month', 'mm', 'm')
	THEN (YEAR(enddate::DATETIME) * 12 + MONTH(enddate::DATETIME)) -
	     (YEAR(startdate::DATETIME) * 12 + MONTH(startdate::DATETIME))
	WHEN datepart IN ('day', 'dd', 'd', 'dayofyear', 'dy', 'y', 'weekday', 'dw', 'w')
	THEN EPOCH(enddate::DATETIME)::BIGINT / 86400 - EPOCH(startdate::DATETIME)::BIGINT / 86400
	WHEN datepart IN ('hour', 'hh')
	THEN EPOCH(enddate::DATETIME)::BIGINT / 3600 - EPOCH(startdate::DATETIME)::BIGINT / 3600
	WHEN datepart IN ('minute', 'mi', 'n')
	THEN EPOCH(enddate::DATETIME)::BIGINT / 60 - EPOCH(startdate::DATETIME)::BIGINT / 60
	WHEN datepart IN ('second', 'ss', 's')
	THEN EPOCH(enddate::DATETIME)::BIGINT - EPOCH(startdate::DATETIME)::BIGINT
	WHEN datepart IN ('millisecond', 'ms')
	THEN ((EPOCH(enddate::DATETIME) - second(enddate::DATETIME)) * 1000 + millisecond(enddate::DATETIME)) -
		 ((EPOCH(startdate::DATETIME) - second(startdate::DATETIME)) * 1000 + millisecond(startdate::DATETIME))
	WHEN datepart IN ('microsecond', 'mcs')
	THEN ((EPOCH(enddate::DATETIME) - second(enddate::DATETIME)) * 1000 * 1000 + microsecond(enddate::DATETIME)) -
	     ((EPOCH(startdate::DATETIME) - second(startdate::DATETIME)) * 1000 * 1000 + microsecond(startdate::DATETIME))
	WHEN datepart IN ('nanosecond')
	THEN ((EPOCH(enddate::DATETIME) - second(enddate::DATETIME)) * 1000 * 1000 + microsecond(enddate::DATETIME)) * 1000 -
	     ((EPOCH(startdate::DATETIME) - second(startdate::DATETIME)) * 1000 * 1000 + microsecond(startdate::DATETIME)) * 1000
	WHEN datepart IN ('week', 'wk', 'ww')
	THEN EPOCH(DATE_TRUNC('week', enddate::DATETIME + interval 1 day))::BIGINT / (7 * 86400) -
	     EPOCH(DATE_TRUNC('week', startdate::DATETIME + interval 1 day))::BIGINT / (7 * 86400)
	ELSE 0
END

# datepart boundaries
foreach datepart 'year' 'quarter' 'month' 'dayofyear' 'day' 'hour' 'minute' 'second' 'millisecond' 'microsecond' 'week'

query I
SELECT DATE_DIFF(${datepart}, '2005-12-31 23:59:59.9999999', '2006-01-01 00:00:00.0000000');
----
1

endloop
