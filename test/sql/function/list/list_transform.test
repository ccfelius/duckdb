# name: test/sql/function/list/list_transform.test
# description: Test list_transform function
# group: [list]

# NOTE: some of these tests are directly taken from the Presto Array Function examples

statement error
SELECT list_transform(NULL, NULL)

statement error
SELECT list_transform(NULL, x)

statement error
SELECT list_transform(NULL, x -> y);

query I
SELECT list_transform(NULL, x -> x + 1)
----
NULL

query I
SELECT list_transform([1], x -> x)
----
[1]

query I
SELECT list_transform([1, 2, 3], x -> 1)
----
[1, 1, 1]

query I
SELECT list_transform([1], x -> x + 1)
----
[2]

query I
SELECT list_transform([1, 2, 3], x -> x + 1)
----
[2, 3, 4]

query I
SELECT list_transform([1, NULL, -2, NULL], x -> x + 1)
----
[2, NULL, -1, NULL]

# fails with Binder Error: Invalid number of left-hand side parameters for this lambda function.
# removing "%prec Op" from "| a_expr LAMBDA_ARROW a_expr %prec Op" in select.y fixes this, but
# then some of the JSON tests fail

# for now I removed "%prec Op", but JSON now needs fixing

query I
SELECT list_transform(['x', 'abc', 'z'], x -> x || '0')
----
[x0, abc0, z0]

mode skip

# this fails with Attempting to initialize state of expression of unknown type!

query I
SELECT list_transform([5, NULL, 6], x -> COALESCE(x, 0) + 1)
----
[6, 1, 7]

query I
SELECT list_transform(list_value(list_unique(list_concat([1,2],[2,2]))), x -> x + 1);
----
[2, 3]

statement ok
CREATE TABLE lists (l integer[])

statement ok
INSERT INTO lists VALUES ([1])

query I
SELECT list_transform(l, x -> x) FROM lists
----
[1]

# nested stuff also still fails

query I
SELECT list_transform([[1]], x -> list_transform(x, y -> y + 1))
----
[[2], [3], [4]]

query I
SELECT list_transform([[1], [2], [3]], x -> list_concat(list_transform(x, y -> y + 1), list_transform(x, z -> z - 1)))
----
[[0,2], [1, 3], [2, 4]]

mode unskip

# TODO: this test case requires the implementation of list_filter

mode skip

query I
SELECT list_transform([[1, NULL, 2], [3, NULL]], a -> list_filter(a, x -> x IS NOT NULL))
----
[[1, 2], [3]]

mode unskip

# TODO: add test cases where the lambda parameter(s) have the same name as columns