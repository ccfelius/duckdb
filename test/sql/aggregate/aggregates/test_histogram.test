# name: test/sql/aggregate/aggregates/test_histogram.test
# description: Test histogram aggregation
# group: [aggregates]

statement ok
PRAGMA enable_verification

# Empty Table
query I
SELECT histogram(i) FROM range(100) tbl(i) WHERE 1=0;
----
NULL

#Corner cases
statement error
select histogram()

query I
select histogram(NULL)
----
NULL

query I
select histogram(1)
----
[<k: 1, v: 1>]

statement error
select histogram(*)

query I
SELECT histogram(2) FROM range(100);
----
[<k: 2, v: 100>]

statement ok
CREATE TABLE hist_data (g INTEGER, e INTEGER)

statement ok
INSERT INTO hist_data VALUES (1, 1), (1, 2), (2, 3), (2, 4), (2, 5), (3, 6), (5, NULL)


query T
SELECT histogram(g) from hist_data
----
[<k: 1, v: 2>, <k: 2, v: 3>, <k: 3, v: 1>, <k: 5, v: 1>]

query T
SELECT histogram(e) from hist_data
----
[<k: 1, v: 1>, <k: 2, v: 1>, <k: 3, v: 1>, <k: 4, v: 1>, <k: 5, v: 1>, <k: 6, v: 1>]

query I
select histogram(g)
    from hist_data
    group by g%2==0
----
[<k: 1, v: 2>, <k: 3, v: 1>, <k: 5, v: 1>]
[<k: 2, v: 3>]

query I
select histogram(g)
    from hist_data
    where g < 3
----
[<k: 1, v: 2>, <k: 2, v: 3>]

statement ok
create table names (name string)

statement ok
insert into names values ('pedro'), ('pedro'), ('pedro'),('hannes'),('hannes'),('mark'),(null);

query I
select histogram(name) from names;
----
[<k: hannes, v: 2>, <k: mark, v: 1>, <k: pedro, v: 3>]

require vector_size 512

query II
select g,histogram(g) over (partition by g%2)
    from hist_data;
----
2	[<k: 2, v: 3>]
2	[<k: 2, v: 3>]
2	[<k: 2, v: 3>]
1	[<k: 1, v: 2>, <k: 3, v: 1>, <k: 5, v: 1>]
1	[<k: 1, v: 2>, <k: 3, v: 1>, <k: 5, v: 1>]
5	[<k: 1, v: 2>, <k: 3, v: 1>, <k: 5, v: 1>]
3	[<k: 1, v: 2>, <k: 3, v: 1>, <k: 5, v: 1>]


