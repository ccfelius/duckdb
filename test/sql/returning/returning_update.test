# name: test/sql/returning/returning_update.test
# description: Test returning with top level INSERT statement
# group: [returning]

statement ok
CREATE TABLE table1 (a INTEGER DEFAULT -1, b INTEGER DEFAULT -2, c INTEGER DEFAULT -3);

statement ok
insert into table1(a) select * from range (0, 4000, 1) t1(a);

mode skip

# basic update
query III
UPDATE table1
SET a=5, b=5, c=5
WHERE a = 1 RETURNING a, b, c;
----
5	5	5

query III
UPDATE table1
SET a=a*2, b=b*2, c=c*2
WHERE a = 2 RETURNING a, b, c;
----
4	-4	-6


# returning 1 named column
query I
UPDATE table1
SET a=a*2, b=b*2, c=c*2
WHERE a = 3 RETURNING a;
----
6

# returning all columns with *
query III
UPDATE table1
SET a=a*2, b=b*2, c=c*2
WHERE a = 4 RETURNING *;
----
8	-8	-12
8	-4	-6

mode unskip

# returning * expression with more named columns
query IIIIII
UPDATE table1
SET a=3, b=2, c=1
WHERE a=10 AND b=-2 AND c=-3 RETURNING *, c, b, a;
----
3	2	1	1	2	3


# returning column names out of order
query III
UPDATE table1
SET c=1, b=2, a=3
WHERE a=12 AND b=-2 AND c=-3 RETURNING c, b, a;
----
1	2	3


mode skip

# returning using a column alias
query III
UPDATE table1
SET c=1, b=2, a=3
WHERE a=11 AND b=-2 AND c=-3 RETURNING a, b, c;
----
1	2

# returning expression with aggregation function is not allowed
statement error
INSERT INTO table1 VALUES (1, 1, 1), (2, 2, 2), (3, 3, 3) RETURNING SUM(a);

# returning * while inserting only a subset of columns
query III
INSERT INTO table1(a) VALUES (10) RETURNING *;
----
10	-2	-3


# returning while insert uses a subquery
query III
INSERT INTO table1 (a, b, c) SELECT * from table1 WHERE a = 10 and b=-2 and c=-3 RETURNING *;
----
10	-2	-3
10	-2	-3

# subquery not allowed in returning statement
statement error
INSERT INTO table1(a, b, c) SELECT * FROM table1 WHERE a = 10 and b=-2 and c=-3 LIMIT 1 RETURNING a IN (SELECT a FROM table1);


# inserting empty subquery returns nothing
query III
INSERT INTO table1 (a, b, c) SELECT * from table1 WHERE a = 100000 and b = 10000 and c=100000 RETURNING a, b, c;
----

# subquery not allowed in returning statement
statement error
INSERT INTO table1 (a, b, c) VALUES (10, 1000, 1000) RETURNING a IN (SELECT a from table1 where b = -2);


# using case statement
query I
INSERT INTO table1 VALUES (1, 2, 3) RETURNING CASE WHEN b=2 THEN a ELSE b END;
----
1

# using case statement
query I
INSERT INTO table1 VALUES (1, 2, 3) RETURNING CASE WHEN b=3 THEN a ELSE b END;
----
2

statement ok
----
DELETE FROM table1;

statement ok
insert into table1(a) select * from range (0, 4000, 1) t1(a);

query I
SELECT count(*) FROM table1;
----
4000

# the following two tests test that all inserts get streamed back to the returning statement
query I
INSERT INTO table1(a, b, c) SELECT a, b, c FROM table1  RETURNING a;
----
4000 values hashing to b28a0440a7c3898c88617db0673db740
