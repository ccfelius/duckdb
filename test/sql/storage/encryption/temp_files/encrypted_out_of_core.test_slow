# name: test/sql/storage/encryption/temp_files/encrypted_out_of_core.test_slow
# description: Encrypted large joins in persistent databases have a leftover temporary directory.
# group: [temp_files]

require tpch

# statement ok
# ATTACH '__TEST_DIR__/bz.db' as bz (BLOCK_SIZE 32768)
#
# statement ok
# USE bz;

statement ok
ATTACH 'encrypted_temp_files_3.db' AS enc (ENCRYPTION_KEY 'asdf');

statement ok
USE enc;

statement ok
SET threads=8

statement ok
SET memory_limit='100MB';

# mode skip

# statement ok
# CALL dbgen(sf=1);

# statement ok
# ALTER TABLE lineitem RENAME TO lineitem1
#
# statement ok
# CREATE TABLE lineitem2 AS FROM lineitem1

# performing a large hash join
statement ok
CREATE OR REPLACE TABLE ans as select l1.*, l2.* from lineitem_smaller l1 JOIN lineitem2_smaller l2 USING (l_orderkey, l_linenumber)

statement ok
DROP TABLE ans;