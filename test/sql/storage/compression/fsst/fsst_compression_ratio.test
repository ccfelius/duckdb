# name: test/sql/storage/compression/fsst/fsst_compression_ratio.test
# description: Assert fsst compression ratio is within reasonable margins
# group: [dictionary]

# load the DB from disk
load __TEST_DIR__/test_dictionary.db

require vector_size 512

# First test: detailed compression ratio
statement ok
PRAGMA force_compression='fsst'

statement ok
CREATE TABLE test_dictionary AS SELECT concat('BEEPBOOP-', (i%3)::VARCHAR) AS i FROM range(0, 1250000) tbl(i);

statement ok
checkpoint

statement ok
PRAGMA force_compression='uncompressed'

statement ok
CREATE TABLE test_uncompressed AS SELECT concat('BEEPBOOP-', (i%3)::VARCHAR) AS i FROM range(0, 1250000) tbl(i);

statement ok
checkpoint

#mode output_result

statement ok
select (uncompressed::FLOAT / dictionary::FLOAT) as compression_ratio  FROM (
    select
        (select count(distinct block_id) from pragma_storage_info('test_dictionary') where segment_type in('VARCHAR')) as dictionary,
        (select count(distinct block_id) from pragma_storage_info('test_uncompressed') where segment_type in('VARCHAR')) as uncompressed
)

# This query keeps a pretty wide margin in compression ratio un purpose to account for possible changes that
# influence compression ratio.
query II
select (uncompressed::FLOAT / dictionary::FLOAT) > 3, (uncompressed::FLOAT / dictionary::FLOAT) < 4  FROM (
    select
        (select count(distinct block_id) from pragma_storage_info('test_dictionary') where segment_type in('VARCHAR')) as dictionary,
        (select count(distinct block_id) from pragma_storage_info('test_uncompressed') where segment_type in('VARCHAR')) as uncompressed
)
----
True	True