# name: test/sql/storage/optimistic_write/optimistic_write.test_slow
# description: Test large appends within individual transactions
# group: [optimistic_write]

load __TEST_DIR__/optimistic_write.db

statement ok
CREATE TABLE test (a INTEGER);

statement ok
INSERT INTO test SELECT * FROM range(1000000)

query I
SELECT SUM(a) FROM test
----
499999500000

restart

statement ok
INSERT INTO test SELECT * FROM range(1000000)

query I
SELECT SUM(a) FROM test
----
999999000000

require skip_reload

# verify in a loop that the size of the system does not increase in case of rollbacks
loop i 0 10

statement ok
BEGIN TRANSACTION;

statement ok
INSERT INTO test SELECT * FROM range(1000000);

statement ok
INSERT INTO test SELECT * FROM range(1000000);

statement ok
ROLLBACK;

# ensure that the expected total storage size is the same as in the first iteration of the loop

query I nosort expected_blocks
SELECT total_blocks FROM pragma_database_size();

statement ok
CHECKPOINT;

endloop

statement ok
INSERT INTO test VALUES (42);

statement ok
CHECKPOINT;

# ensure that the expected total storage size is the same as in the first iteration of the loop

query I nosort expected_blocks
SELECT total_blocks FROM pragma_database_size();
