# name: test/sql/storage/parallel/batch_insert_small_batches.test_slow
# description: Test batch insert with small batches
# group: [parallel]

require parquet

load __TEST_DIR__/insert_small_batches.db


statement ok
COPY (FROM range(1000000) tbl(i)) TO '__TEST_DIR__/small_batches.parquet' (ROW_GROUP_SIZE 5000)

query I
CREATE TABLE integers AS FROM '__TEST_DIR__/small_batches.parquet';
----
1000000

# verify that we are not consuming an unnecessarily giant amount of blocks
# we have a total of 1.1M values - this should not be more than 20 row groups (ideally it is 10)
query I
select count(distinct row_group_id) < 20 from pragma_storage_info('integers');
----
true

# now do the same, but filter out half of the values
query I
CREATE TABLE integers2 AS FROM '__TEST_DIR__/small_batches.parquet' WHERE (i/10000)%2=0;
----
500000

# verify that we are not consuming an unnecessarily giant amount of blocks
# we have a total of 500K values - this should not be more than 10 row groups (ideally it is 5)
query I
select count(distinct row_group_id) < 20 from pragma_storage_info('integers2');
----
true
