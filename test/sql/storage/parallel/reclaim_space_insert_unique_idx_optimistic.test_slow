# name: test/sql/storage/parallel/reclaim_space_insert_unique_idx_optimistic.test_slow
# description: Test space reclamation of optimistic writing with a UNIQUE constraint violation.
# group: [parallel]

load __TEST_DIR__/reclaim_space_unique_index.db

statement ok
SET preserve_insertion_order=false;

statement ok
CREATE TABLE integers AS SELECT * FROM range(1_000_000) t(i);

statement ok
CREATE TABLE integers2 (i INTEGER);

statement ok
CREATE TABLE total_blocks_tbl AS SELECT total_blocks FROM pragma_database_size();

statement ok
BEGIN;

statement ok
CHECKPOINT;

statement ok
INSERT INTO integers2 VALUES (999_998);

statement ok
INSERT INTO integers2 SELECT * FROM integers WHERE i <= 999_998;

statement ok
ROLLBACK

statement ok
UPDATE total_blocks_tbl SET total_blocks = (
SELECT current.total_blocks FROM pragma_database_size() AS current);
