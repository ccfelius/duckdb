# name: test/sql/storage/external_file_cache/external_file_cache_parquet.test_slow
# description: Test the external file cache for Parquet
# group: [external_file_cache]

require tpch

require parquet

# we first export lineitem sf0.1 to a Parquet file with a single row group
statement ok
create schema my_temporary_schema;

statement ok
call dbgen(sf=0.1, schema='my_temporary_schema');

statement ok
copy my_temporary_schema.lineitem to '__TEST_DIR__/lineitem.parquet' (row_group_size 1_000_000);

statement ok
drop schema my_temporary_schema cascade;

# this is empty since we didn't query anything yet
query II
select format_bytes(nr_bytes), loaded from duckdb_external_file_cache() order by location;
----


# for now, caching is only triggered when prefetching (used for remote files), so let's force it
statement ok
set prefetch_all_parquet_files=true;

statement ok
create view lineitem as from '__TEST_DIR__/lineitem.parquet';

# creating the view has loaded the footer
query II
select format_bytes(nr_bytes), loaded from duckdb_external_file_cache() order by location;
----
1.9 KiB	true

# select the first column
statement ok
select l_orderkey from lineitem;

query II
select format_bytes(nr_bytes), loaded from duckdb_external_file_cache() order by location;
----
913.3 KiB	1
1.9 KiB	1

# select the third column (not contiguous with the first column so it should have two cache entries)
statement ok
select l_suppkey from lineitem;

query II
select format_bytes(nr_bytes), loaded from duckdb_external_file_cache() order by location;
----
913.3 KiB	true
739.4 KiB	true
1.9 KiB	true

# select the first four columns (contiguous, and supersede the previous two cache entries, should merge into one entry)
statement ok
select l_orderkey, l_partkey, l_suppkey, l_linenumber from lineitem;

query II
select format_bytes(nr_bytes), loaded from duckdb_external_file_cache() order by location;
----
2.9 MiB	1
1.9 KiB	1

# shows up in duckdb_memory under its own tag
# this is slightly higher than the sum of nr_bytes above due buffers having a header and are rounded up to sector size
query I
select memory_usage_bytes from duckdb_memory() where tag = 'EXTERNAL_FILE_CACHE';
----
3051520

# set the memory so low that the ~3MB entry should be unloaded
statement ok
set memory_limit='100kb';

# set it back to something reasonable so we can actually do the following queries
statement ok
set memory_limit='500mb';

# loaded should now be "false" for the large buffer
query II
select format_bytes(nr_bytes), loaded from duckdb_external_file_cache() where location = 4;
----
2.9 MiB	0

# disabling the file cache should empty it
statement ok
set enable_external_file_cache=false;

query II
select format_bytes(nr_bytes), loaded from duckdb_external_file_cache() order by location;
----


# test that we notice cache invalidation by rapidly overwriting
statement ok
set enable_external_file_cache=true;

loop i 0 100

statement ok
copy (select ${i} i) to '__TEST_DIR__/i.parquet';

query I
select i = ${i} from '__TEST_DIR__/i.parquet';
----
true

endloop
