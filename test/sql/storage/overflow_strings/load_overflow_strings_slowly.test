# name: test/sql/storage/overflow_strings/load_overflow_strings_slowly.test
# description: Test loading overflow strings in small batches
# group: [overflow_strings]

load __TEST_DIR__/overflow_strings.db

loop x 0 10

statement ok
CREATE TABLE strings(s VARCHAR);

# load large strings into the table iteratively
loop it 0 10

statement ok
INSERT INTO strings SELECT repeat('X', CASE WHEN i % 17 = 0 THEN 5000 ELSE i % 7 END) AS s FROM generate_series(0, 2500) tbl(i);

statement ok
CHECKPOINT;

endloop

query I
SELECT EXISTS (SELECT * FROM pragma_storage_info('strings') WHERE contains(segment_info, 'Overflow String'));
----
1

# we expect a storage size of approximately 14 MiB (14680064 bytes),
# and we allow a variation of 20% in storage size

query I
SELECT total_blocks < (14680064 / get_block_size('overflow_strings') * 1.2) FROM pragma_database_size();
----
1

statement ok
DROP TABLE strings;

endloop
