# name: test/sql/generated_columns/virtual/cascading_delete.test
# description: Test the chain reaction effect of deleting a column that is a dependency of a generated column
# which itself is also a dependency of a generated column
# group: [virtual]

statement ok
CREATE TABLE unit (price INTEGER, amount_sold INTEGER);

statement ok
INSERT INTO unit VALUES (5,4)

statement ok
ALTER TABLE unit ADD COLUMN total_profit INTEGER GENERATED ALWAYS AS(price * amount_sold) VIRTUAL;

statement ok
ALTER TABLE unit ADD COLUMN profit_total AS (total_profit);

statement ok
ALTER TABLE unit ADD COLUMN dependent AS (profit_total);

statement ok
ALTER TABLE unit ADD COLUMN also_dependent AS (profit_total * dependent)

statement ok
ALTER TABLE unit ADD COLUMN dont_delete_me AS (amount_sold);

query IIIIIII
SELECT * FROM unit;
----
5	4	20	20	20	400	4

# Is a dependency of 1 or more columns - CASCADE required
statement error
ALTER TABLE unit DROP COLUMN price;

statement ok
ALTER TABLE unit DROP COLUMN price CASCADE;

query II
SELECT * FROM unit;
----
4	4
