# name: test/sql/secrets/create_secret_serialization_demo.test
# description: Demo of secret serialization
# group: [secrets]

# NOTE: this is a testing feature that will be removed / replaced with actual persistent secrets.

require httpfs

require parquet

load __TEST_DIR__/test_serialize_secrets.db

statement ok
PRAGMA enable_verification;

statement ok
CREATE SECRET s1 (
    TYPE S3,
    PROVIDER config,
    KEY_ID 'mekey',
    SECRET 'mesecret',
    REGION 'meregion',
    SESSION_TOKEN 'mesesh',
    ENDPOINT 'meendpoint',
    URL_STYLE 'mahstyle',
    USE_SSL '1',
    URL_COMPATIBILITY_MODE '1'
)

statement ok
CREATE SECRET s2 (
    TYPE S3,
    PROVIDER config,
    KEY_ID 'mekey2',
    SECRET 'mesecret2',
    REGION 'meregion2',
    SESSION_TOKEN 'mesesh2',
    ENDPOINT 'meendpoint2',
    URL_STYLE 'mahstyle2',
    USE_SSL '0',
    URL_COMPATIBILITY_MODE '0'
)

statement ok
CALL duckdb_secrets_to_file("__TEST_DIR__/serialized_secrets.bin");

restart

# After restart secrets are gone
query IIIIII
FROM duckdb_secrets();
----

# Load them from a file
statement ok
CALL duckdb_secrets_from_file("__TEST_DIR__/serialized_secrets.bin");

# Voila!
query IIIIII
FROM duckdb_secrets(redact=false);
----
s1	s3	config	in-memory	[s3://]	;access_key_id=mekey;secret_access_key=mesecret;region=meregion;use_ssl=true;session_token=mesesh;s3_url_compatibility_mode=true;endpoint=meendpoint;url_style=mahstyle
s2	s3	config	in-memory	[s3://]	;access_key_id=mekey2;secret_access_key=mesecret2;region=meregion2;use_ssl=false;session_token=mesesh2;s3_url_compatibility_mode=false;endpoint=meendpoint2;url_style=mahstyle2

query IIIIII
FROM duckdb_secrets();
----
s1	s3	config	in-memory	[s3://]	;access_key_id=mekey;secret_access_key=redacted;region=meregion;use_ssl=true;session_token=redacted;s3_url_compatibility_mode=true;endpoint=meendpoint;url_style=mahstyle
s2	s3	config	in-memory	[s3://]	;access_key_id=mekey2;secret_access_key=redacted;region=meregion2;use_ssl=false;session_token=redacted;s3_url_compatibility_mode=false;endpoint=meendpoint2;url_style=mahstyle2