# name: test/sql/secrets/create_secret_serialization_demo.test
# description: Demo of secret serialization
# group: [tmp]

require httpfs

require parquet

load __TEST_DIR__/test_serialize_secrets.db

statement ok
CREATE SECRET s1 (
    TYPE S3,
    PROVIDER config,
    KEY_ID 'mekey',
    SECRET 'mesecret',
    REGION 'meregion'
)

statement ok
CREATE SECRET s2 (
    TYPE S3,
    PROVIDER config,
    KEY_ID 'mekey2',
    SECRET 'mesecret2',
    REGION 'meregion2'
)

statement ok
CALL duckdb_secrets_to_file("__TEST_DIR__/serialized_secrets.bin");

restart

# After restart secrets are gone
query IIIII
FROM duckdb_secrets();
----

# Load them from a file
statement ok
CALL duckdb_secrets_from_file("__TEST_DIR__/serialized_secrets.bin");

# Voila!
query IIIII
FROM duckdb_secrets();
----
s1	s3	config	[s3://]	region=meregion;access_key_id=mekey;secret_access_key=<redacted>;session_token=;endpoint=s3.amazonaws.com;url_style=;use_ssl=1;s3_url_compatibility_mode=0
s2	s3	config	[s3://]	region=meregion2;access_key_id=mekey2;secret_access_key=<redacted>;session_token=;endpoint=s3.amazonaws.com;url_style=;use_ssl=1;s3_url_compatibility_mode=0