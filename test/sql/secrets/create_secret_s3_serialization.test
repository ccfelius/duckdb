# name: test/sql/secrets/create_secret_serialization_demo.test
# description: Demo of secret serialization
# group: [secrets]

# NOTE: this is a testing feature that will be removed / replaced with actual persistent secrets.

require httpfs

require parquet

load __TEST_DIR__/test_serialize_secrets.db

statement ok
PRAGMA enable_verification;

statement ok
set secret_directory='__TEST_DIR__/create_secret_serialization_demo'

statement ok
CREATE OR REPLACE PERMANENT SECRET s1 (
    TYPE S3,
    PROVIDER config,
    SCOPE ['s3://my_scope'],
    KEY_ID 'mekey',
    SECRET 'mesecret',
    REGION 'meregion',
    SESSION_TOKEN 'mesesh',
    ENDPOINT 'meendpoint',
    URL_STYLE 'mahstyle',
    USE_SSL '1',
    URL_COMPATIBILITY_MODE '1'
)

query IIII
select name, type, provider, scope FROM duckdb_secrets();
----
s1	s3	config	[s3://my_scope]

restart

# Now setting the secret dir somehwere nonexistent will yield no permanent secrets
statement ok
set secret_directory='__TEST_DIR__/does_not_exist'

query I
select count(*) FROM duckdb_secrets();
----
0

# However setting it to the dir that does, we can suddenly see our persisted secrets
statement ok
set secret_directory='__TEST_DIR__/create_secret_serialization_demo'

# After restart secret is still there
query IIII
select name, type, provider, scope FROM duckdb_secrets();
----
s1	s3	config	[s3://my_scope]