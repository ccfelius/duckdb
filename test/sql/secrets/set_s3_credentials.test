# name: test/sql/copy/s3/set_s3_credentials.test
# description: tests the set_s3_credentials function
# group: [s3]

require httpfs

require parquet

### Setup credentials

# Set some credentials for global usage
statement ok
set s3_endpoint='glob.reg.cred.use.this.domain.com'

statement ok
CREATE SECRET main_secret TYPE=S3

# Set credentials for a specific bucket
statement ok
set s3_endpoint='bucket1.endpoint.bogusdomain.com'

statement ok
CREATE SECRET scoped_secret_1 TYPE=S3 SCOPE='s3://bucket1'

# Set credentials for other bucket
statement ok
set s3_endpoint='bucket2.endpoint.bogusdomain.com'

statement ok
CREATE SECRET scoped_secret_2 TYPE=S3 SCOPE='s3://bucket2'

# Set credentials for some specific file in bucket2
statement ok
set s3_endpoint='bucket2.endpoint.for.path.bogusdomain.com'

statement ok
CREATE SECRET scoped_secret_3 TYPE=S3 SCOPE='s3://bucket2/this/path/takes/other/creds/'

# Finally, set the global credentials to something else: these should not be used as long as our urls match
statement ok
set s3_endpoint='duckdb.settings.endpoint.bogusdomain.com'

### Testing credentials match correctly

statement error
from "s3://bucket1/test.parquet"
----
bucket1.endpoint.bogusdomain.com

statement error
from "s3://bucket2/test.parquet"
----
bucket2.endpoint.bogusdomain.com

statement error
from "s3://bucket2/this/path/takes/other/creds/test.parquet"
----
bucket2.endpoint.for.path.bogusdomain.com

statement error
from "s3://bucket3/test.parquet"
----
glob.reg.cred.use.this.domain.com

query III
select id, type, scope from duckdb_credentials() order by id;
----
1	s3	[s3://, r2://, gcs://]
2	s3	[s3://bucket1]
3	s3	[s3://bucket2]
4	s3	[s3://bucket2/this/path/takes/other/creds/]

# Check the endpoints are actually set
query I
select
    list_filter(split(credential_string,';'), x -> starts_with(x, 'endpoint'))[1]
from duckdb_credentials();
----
endpoint=glob.reg.cred.use.this.domain.com
endpoint=bucket1.endpoint.bogusdomain.com
endpoint=bucket2.endpoint.bogusdomain.com
endpoint=bucket2.endpoint.for.path.bogusdomain.com