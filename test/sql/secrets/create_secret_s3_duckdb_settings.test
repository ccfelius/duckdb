# name: test/sql/secrets/create_secret_s3_duckdb_settings.test
# description: Test the duckdb_settings credential provider for the s3/r2/gcs type credentials
# group: [s3]

require httpfs

require parquet

#statement ok
#PRAGMA enable_verification;

### NOTE: this is for testing purposes, this feature will be removed and replaced by a proper credential provider
#         that uses the AWS SDK.

# Set some credentials for main_secret
statement ok
set s3_endpoint='glob.reg.cred.use.this.domain.com'

# This secret is now created based on the current duckdb settings
statement ok
CREATE SECRET main_secret
TYPE S3
USING duckdb_settings

# Set credentials for scoped_secret_1
statement ok
set s3_endpoint='bucket1.endpoint.bogusdomain.com'

statement ok
CREATE SECRET scoped_secret_1
TYPE S3
USING duckdb_settings
SCOPE 's3://bucket1'

# Set credentials for other bucket
statement ok
set s3_endpoint='bucket2.endpoint.bogusdomain.com'

statement ok
CREATE SECRET scoped_secret_2
TYPE S3
USING duckdb_settings
SCOPE 's3://bucket2'

# Set credentials for some specific file in bucket2
statement ok
set s3_endpoint='bucket2.endpoint.for.path.bogusdomain.com'

statement ok
CREATE SECRET scoped_secret_3
TYPE S3
USING duckdb_settings
SCOPE 's3://bucket2/this/path/takes/other/creds/'

# Finally, set the global credentials to something else: these should not be used as long one of the secret scopes matches
statement ok
set s3_endpoint='duckdb.settings.endpoint.bogusdomain.com'

### Testing our scope is properly matched to the urls

statement error
from "s3://bucket1/test.parquet"
----
bucket1.endpoint.bogusdomain.com

statement error
from "s3://bucket2/test.parquet"
----
bucket2.endpoint.bogusdomain.com

statement error
from "s3://bucket2/this/path/takes/other/creds/test.parquet"
----
bucket2.endpoint.for.path.bogusdomain.com

statement error
from "s3://bucket3/test.parquet"
----
glob.reg.cred.use.this.domain.com

query III
select id, type, scope from duckdb_credentials() order by id;
----
1	s3	[s3://]
2	s3	[s3://bucket1]
3	s3	[s3://bucket2]
4	s3	[s3://bucket2/this/path/takes/other/creds/]

# Check the endpoints are actually set TODO: we should have dedicated <type>_credentials for this that can nicely print
# secrets of type x
query I
select
    list_filter(split(credential_string,';'), x -> starts_with(x, 'endpoint'))[1]
from duckdb_credentials();
----
endpoint=glob.reg.cred.use.this.domain.com
endpoint=bucket1.endpoint.bogusdomain.com
endpoint=bucket2.endpoint.bogusdomain.com
endpoint=bucket2.endpoint.for.path.bogusdomain.com

# Note: the settings from the provider can still be overridden
statement ok
set s3_endpoint='duckdb.settings.endpoint.to.be.overridden.bogusdomain.com'

statement ok
set s3_region='eu-west-1'

statement ok
CREATE SECRET overridden_region_secret
TYPE S3
USING duckdb_settings
SCOPE 's3://bucket4/'
WITH (
    REGION 'overridden-region'
)

query I
select
    list_filter(split(credential_string,';'), x -> starts_with(x, 'region'))[1]
from duckdb_credentials() where name='overridden_region_secret';
----
region=overridden-region