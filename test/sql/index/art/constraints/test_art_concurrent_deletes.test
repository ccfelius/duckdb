# name: test/sql/index/art/constraints/test_art_concurrent_deletes.test
# description: Test DELETE + INSERT in the main connection with concurrent deletes in other connections.
# group: [constraints]

statement ok
PRAGMA enable_verification

statement ok
CREATE TABLE tbl (id INT PRIMARY KEY, payload VARCHAR);

statement ok
INSERT INTO tbl VALUES (1, 'first payload');

# con1 open.

statement ok con1
BEGIN TRANSACTION;

statement ok con1
DELETE FROM tbl;

statement ok con1
INSERT INTO tbl VALUES (1, 'con1 payload');

statement ok
BEGIN TRANSACTION

statement error
DELETE FROM tbl;
----
<REGEX>:TransactionContext Error.*Conflict on tuple deletion.*

statement ok
COMMIT;

# con1 and con2 open.

statement ok con2
BEGIN TRANSACTION;

statement error con2
DELETE FROM tbl;
----
<REGEX>:TransactionContext Error.*Conflict on tuple deletion.*

statement ok
BEGIN TRANSACTION;

statement error
DELETE FROM tbl;
----
<REGEX>:TransactionContext Error.*Conflict on tuple deletion.*

statement ok
COMMIT;

statement ok con1
COMMIT;

statement ok con2
COMMIT

query III
SELECT id, payload, rowid FROM tbl ORDER BY ALL;
----
1	con1 payload	1

# Now with a LIST column.

statement ok
CREATE TABLE tbl_list (id INT PRIMARY KEY, payload VARCHAR);

statement ok
INSERT INTO tbl_list VALUES (1, 'first payload');

statement ok con1
BEGIN TRANSACTION;

statement ok con1
DELETE FROM tbl_list;

statement ok con1
INSERT INTO tbl_list VALUES (1, 'con1 payload');

statement ok
BEGIN TRANSACTION

statement error
DELETE FROM tbl_list;
----
<REGEX>:TransactionContext Error.*Conflict on tuple deletion.*

statement ok
COMMIT;

statement ok con1
COMMIT;

query III
SELECT id, payload, rowid FROM tbl_list ORDER BY ALL;
----
1	con1 payload	1

# ROLLBACK due to a constraint violation during the transaction.

statement ok
CREATE TABLE tbl_rollback (id INT PRIMARY KEY, payload VARCHAR);

statement ok
INSERT INTO tbl_rollback VALUES (1, 'first payload');

statement ok con1
BEGIN TRANSACTION;

statement ok con1
DELETE FROM tbl_rollback;

statement ok con1
INSERT INTO tbl_rollback VALUES (1, 'con1 payload');

statement error con1
INSERT INTO tbl_rollback VALUES (1, 'con1 payload');
----
<REGEX>:Constraint Error.*PRIMARY KEY or UNIQUE constraint violation.*

statement error con1
BEGIN TRANSACTION;
----
<REGEX>:TransactionContext Error.*Current transaction is aborted.*

statement ok con1
ROLLBACK;

query III
SELECT id, payload, rowid FROM tbl_rollback ORDER BY ALL;
----
1	first payload	0