# name: test/sql/delete/test_delete_indexed.test
# description: Test deletions on tables with indexes
# group: [delete]

statement ok
PRAGMA enable_verification

statement ok
CREATE TABLE t (id INT PRIMARY KEY, j BIGINT, s TEXT);

statement ok
CREATE INDEX idx ON t(j);

statement ok
INSERT INTO t VALUES (1, 10, 'a'), (2, 20, 'b'), (3, 30, 'c');

# verify initial state
query III
SELECT * FROM t ORDER BY id;
----
1	10	a
2	20	b
3	30	c

# delete using primary key
statement ok
DELETE FROM t WHERE id = 2;

query III
SELECT * FROM t ORDER BY id;
----
1	10	a
3	30	c

# delete using indexed column
statement ok
DELETE FROM t WHERE j = 30;

query III
SELECT * FROM t ORDER BY id;
----
1	10	a

# insert more data
statement ok
INSERT INTO t VALUES (4, 40, 'd'), (5, 50, 'e');

# test transaction rollback
statement ok
BEGIN TRANSACTION

statement ok
DELETE FROM t WHERE j > 10;

query III
SELECT * FROM t ORDER BY id;
----
1	10	a

statement ok
ROLLBACK

query III
SELECT * FROM t ORDER BY id;
----
1	10	a
4	40	d
5	50	e

# delete everything
statement ok
DELETE FROM t;

query I
SELECT COUNT(*) FROM t;
----
0

# test delete and insert in same transaction with overlapping values
statement ok
INSERT INTO t VALUES (1, 10, 'a'), (2, 20, 'b'), (3, 30, 'c');

statement ok
BEGIN TRANSACTION;

# delete rows with j=20,30
statement ok
DELETE FROM t WHERE j >= 20;

# insert new rows with same ids and j values
statement ok
INSERT INTO t VALUES (2, 20, 'new_20'), (3, 30, 'new_30');

# verify index lookup during transaction
query III
SELECT * FROM t WHERE j = 20;
----
2	20	new_20

query III
SELECT * FROM t WHERE j = 30;
----
3	30	new_30

statement ok
COMMIT;

# verify index lookups after commit
query III
SELECT * FROM t WHERE j = 20;
----
2	20	new_20

query III
SELECT * FROM t WHERE j = 30;
----
3	30	new_30

# test rollback with overlapping values
statement ok
BEGIN TRANSACTION;

# delete rows with j=20,30
statement ok
DELETE FROM t WHERE j >= 20;

# insert rows with same ids and j values again
statement ok
INSERT INTO t VALUES (2, 20, 'tmp_20'), (3, 30, 'tmp_30');

# verify index lookup during transaction
query III
SELECT * FROM t WHERE j = 20;
----
2	20	tmp_20

query III
SELECT * FROM t WHERE j = 30;
----
3	30	tmp_30

statement ok
ROLLBACK;

# verify index lookups after rollback
query III
SELECT * FROM t WHERE j = 20;
----
2	20	new_20

query III
SELECT * FROM t WHERE j = 30;
----
3	30	new_30

# verify range queries on index
query III
SELECT * FROM t WHERE j >= 20 ORDER BY j;
----
2	20	new_20
3	30	new_30
