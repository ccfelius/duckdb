# name: test/sql/sample/table_sample_converts_to_block_sample.test
# description: Test sampling of larger relations
# group: [sample]

require vector_size 2048

# table samples first collect only 1% of the table, until the table has a cardinality of 2048.
# then the sample stays at a fixed 2048 values.

load __TEST_DIR__/test_sample_converts_after_load.db

statement ok
create table materialized_range as select 1 a from range(102400);

# only 1% of 102400
query I
select count(*) from pragma_table_sample('materialized_range');
----
1024

restart

statement ok
insert into materialized_range select 2 a from range(102400);

# collect another 1% of 102400
query I
select count(*) from pragma_table_sample('materialized_range');
----
2048

query II
select a, count(*) from pragma_table_sample('materialized_range') group by all order by a;
----
1	1024
2	1024


# insert another
statement ok
insert into materialized_range select 3 a from range(102400);

# sample remains at 2048 values
query I
select count(*) from pragma_table_sample('materialized_range');
----
2048

statement ok
pragma threads=1;

# the above seems skewed, but this test shows that if all samples are added at the same time
# to a reservoir sample, they are not skewed
query II
select a, count(*) from (select( range%3+1) as a from range(102400 * 3)) t(a) group by all USING SAMPLE reservoir(2048 rows) REPEATABLE (200) order by a;
----
1	696
2	678
3	674