# name: test/sql/logging/filehandle_logging_attach.test
# group: [logging]

require parquet

require json

statement ok
pragma threads=1;

statement ok
set enable_logging = true;

statement ok
set logging_level='trace';

statement ok
attach '__TEST_DIR__/filehandle_logging.db' as db;

statement ok
CREATE TABLE db.test AS SELECT 1;

statement ok
DETACH db;

# Create a view that json_transforms the log entries
statement ok
CREATE VIEW file_handle_log AS
    SELECT json_transform(message, '{"fs": "VARCHAR", "op": "VARCHAR", "path": "VARCHAR", "bytes": "BIGINT", "pos": "BIGINT"}') as message
    FROM duckdb_logs
    WHERE type = 'duckdb.FileHandle'
    ORDER BY timestamp

# Create a view that json_untransforms the log entries
query IIIII
SELECT
    message.fs,
    message.op,
    filename: parse_filename(message.path),
    bytes: message.bytes,
    message.pos
FROM file_handle_log
----
LocalFileSystem	OPEN	filehandle_logging.db	NULL	NULL
LocalFileSystem	WRITE	filehandle_logging.db	4096	0
LocalFileSystem	WRITE	filehandle_logging.db	4096	4096
LocalFileSystem	WRITE	filehandle_logging.db	4096	8192
LocalFileSystem	WRITE	filehandle_logging.db	262144	12288
LocalFileSystem	WRITE	filehandle_logging.db	4096	4096
LocalFileSystem	CLOSE	filehandle_logging.db	NULL	NULL
