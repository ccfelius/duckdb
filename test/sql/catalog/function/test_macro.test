# name: test/sql/catalog/function/test_macro.test
# description: Test Macro
# group: [function]

statement ok
PRAGMA enable_verification

# b cannot be found
statement error
CREATE MACRO add(a) AS a+b

# cannot create function with existing name
statement error
CREATE MACRO string_split(a,b) AS a+b

statement ok
CREATE MACRO one() AS (SELECT 1);

query T
SELECT one()
----
1

statement ok
CREATE MACRO IFELSE(a,b,c) AS CASE WHEN a THEN b ELSE c END

# cannot create function with same name different parameters
statement error
CREATE MACRO IFELSE(a,b) AS a+b

# cannot supply argument with side effects
statement error
SELECT IFELSE(RANDOM(), 'true', 'false')

query T
SELECT IFELSE(1,'true','false')
----
true

query T
SELECT IFELSE(0,'true','false')
----
false

query T
SELECT IFELSE(1, IFELSE(1,'a','b'), 'c')
----
a

query T
SELECT IFELSE(1, IFELSE(0,'a','b'), 'c')
----
b

query T
SELECT IFELSE(0, IFELSE(1,'a','b'), 'c')
----
c

statement ok
CREATE MACRO subquery(a) AS (SELECT a)

query T
SELECT subquery(1)
----
1

query T
SELECT subquery(NULL)
----
1

statement ok
CREATE TABLE test (a INT)

statement ok
CREATE MACRO bla(a) AS (SELECT a+a FROM test)

statement ok
INSERT INTO test VALUES (1)

query T
SELECT bla(3)
----
6

statement ok
CREATE MACRO cte_query(a) AS (WITH cte AS (SELECT 42 AS answer) SELECT answer + a FROM cte)

query T
SELECT cte_query(42)
----
84

