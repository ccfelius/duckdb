# name: test/sql/alter/not_null/test_not_null_multi_tran.test
# description: Test Set/Drop NOT NULL in multiple transactions
# group: [alter_col]

statement ok
PRAGMA enable_verification

# Scenario #1, tran2 insert null, tran1 failed to commit
statement ok con1
CREATE TABLE t(i INTEGER, j INTEGER)

statement ok con1
BEGIN TRANSACTION

statement ok con1
ALTER TABLE t ALTER COLUMN j SET NOT NULL

statement ok con2
BEGIN TRANSACTION

statement ok con2
INSERT INTO t VALUES(7777, NULL)

statement ok con2
COMMIT

statement error con1
COMMIT

query I con1
SELECT i FROM t WHERE j IS NULL
----
7777

# Scenario #2, tran1 set not null, tran2 failed to commit
statement ok con1
DROP TABLE IF EXISTS t

statement ok con1
CREATE TABLE t(i INTEGER, j INTEGER)

statement ok con1
BEGIN TRANSACTION

statement ok con2
BEGIN TRANSACTION

statement ok con1
ALTER TABLE t ALTER COLUMN j SET NOT NULL

statement ok con2
BEGIN TRANSACTION

statement ok con2
INSERT INTO t VALUES(7777, NULL)

statement ok con1
COMMIT

statement error con2
COMMIT

statement error con1
INSERT INTO t VALUES(7777, NULL)

query I con1
SELECT COUNT(*) FROM  t
----
0

# Scenario #3, both trans succeeded
statement ok con1
DROP TABLE IF EXISTS t

statement ok con1
CREATE TABLE t(i INTEGER, j INTEGER)

statement ok con1
BEGIN TRANSACTION

statement ok con2
BEGIN TRANSACTION

statement ok con1
ALTER TABLE t ALTER COLUMN j SET NOT NULL

statement ok con2
BEGIN TRANSACTION

statement ok con2
INSERT INTO t VALUES(1, 1)

statement ok con1
COMMIT

statement ok con2
COMMIT

query I con1
SELECT * from t
----
1	1

