# name: test/sql/json/test_json_tpch.test_slow
# description: Test TPCH with JSON
# group: [json]

require json

require tpch

statement ok
call dbgen(sf=0.1)

query IIIIIIIIIIIII nosort q0
select * from lineitem order by all
----

# create lineitem json table
statement ok
create table lineitem_j as
    select json(row(l_orderkey,l_partkey,l_suppkey,l_linenumber,l_quantity,l_extendedprice,l_discount,l_tax,l_returnflag,
                    l_linestatus,l_shipdate,l_commitdate,l_receiptdate,l_shipinstruct,l_shipmode,l_comment)) as j
    from lineitem

# get the json structure
query T
select json_structure(j) from lineitem_j limit 1
----
{"l_orderkey":"integer","l_partkey":"integer","l_suppkey":"integer","l_linenumber":"integer","l_quantity":"integer","l_extendedprice":"real","l_discount":"real","l_tax":"real","l_returnflag":"string","l_linestatus":"string","l_shipdate":"string","l_commitdate":"string","l_receiptdate":"string","l_shipinstruct":"string","l_shipmode":"string","l_comment":"string"}

# transform the structure back to what it was and verify we get the same output as on the original lineitem table
query IIIIIIIIIIIII nosort q0
with transformed as (
    select json_transform(j, '{"l_orderkey":"integer","l_partkey":"integer","l_suppkey":"integer","l_linenumber":"integer","l_quantity":"integer","l_extendedprice":"real","l_discount":"real","l_tax":"real","l_returnflag":"string","l_linestatus":"string","l_shipdate":"string","l_commitdate":"string","l_receiptdate":"string","l_shipinstruct":"string","l_shipmode":"string","l_comment":"string"}') as j
    from lineitem_j
),
corrected as (
    select cast(j as struct(l_orderkey integer, l_partkey integer, l_suppkey integer, l_linenumber integer, l_quantity integer, l_extendedprice decimal(15,2), l_discount decimal(15,2), l_tax decimal(15,2), l_returnflag varchar, l_linestatus varchar, l_shipdate date, l_commitdate date, l_receiptdate date, l_shipinstruct varchar, l_shipmode varchar, l_comment varchar)) as j
    from transformed
)
select j.l_orderkey,j.l_partkey,j.l_suppkey,j.l_linenumber,j.l_quantity,j.l_extendedprice,j.l_discount,j.l_tax,j.l_returnflag,j.l_linestatus,j.l_shipdate,j.l_commitdate,j.l_receiptdate,j.l_shipinstruct,j.l_shipmode,j.l_comment
from corrected order by all
----

# run TPC-H Q1 on the cast lineitem table
query IIIIIIIIII nosort q1
with lineitem_cast as (
    select l_orderkey,l_partkey,l_suppkey,l_linenumber,l_quantity,l_extendedprice::DOUBLE::DECIMAL(15,2) as l_extendedprice,
           l_discount::DOUBLE::DECIMAL(15,2) as l_discount,l_tax::DOUBLE::DECIMAL(15,2) as l_tax,l_returnflag,l_linestatus,
           l_shipdate,l_commitdate,l_receiptdate,l_shipinstruct,l_shipmode,l_comment
    from lineitem
)
SELECT
    l_returnflag,
    l_linestatus,
    sum(l_quantity) AS sum_qty,
    sum(l_extendedprice) AS sum_base_price,
    sum(l_extendedprice * (1 - l_discount)) AS sum_disc_price,
    sum(l_extendedprice * (1 - l_discount) * (1 + l_tax)) AS sum_charge,
    avg(l_quantity) AS avg_qty,
    avg(l_extendedprice) AS avg_price,
    avg(l_discount) AS avg_disc,
    count(*) AS count_order
FROM
    lineitem_cast
WHERE
    l_shipdate <= CAST('1998-09-02' AS date)
GROUP BY
    l_returnflag,
    l_linestatus
ORDER BY
    l_returnflag,
    l_linestatus;
----

# run TPCH-Q1
query IIIIIIIIII nosort q1
with transformed as (
    select json_transform(j, '{"l_orderkey":"integer","l_partkey":"integer","l_suppkey":"integer","l_linenumber":"integer","l_quantity":"integer","l_extendedprice":"real","l_discount":"real","l_tax":"real","l_returnflag":"string","l_linestatus":"string","l_shipdate":"string","l_commitdate":"string","l_receiptdate":"string","l_shipinstruct":"string","l_shipmode":"string","l_comment":"string"}') as j
    from lineitem_j
),
corrected as (
    select cast(j as struct(l_orderkey integer, l_partkey integer, l_suppkey integer, l_linenumber integer, l_quantity integer, l_extendedprice decimal(15,2), l_discount decimal(15,2), l_tax decimal(15,2), l_returnflag varchar, l_linestatus varchar, l_shipdate date, l_commitdate date, l_receiptdate date, l_shipinstruct varchar, l_shipmode varchar, l_comment varchar)) as j
    from transformed
)
SELECT
    j.l_returnflag,
    j.l_linestatus,
    sum(j.l_quantity) AS sum_qty,
    sum(j.l_extendedprice) AS sum_base_price,
    sum(j.l_extendedprice * (1 - j.l_discount)) AS sum_disc_price,
    sum(j.l_extendedprice * (1 - j.l_discount) * (1 + j.l_tax)) AS sum_charge,
    avg(j.l_quantity) AS avg_qty,
    avg(j.l_extendedprice) AS avg_price,
    avg(j.l_discount) AS avg_disc,
    count(*) AS count_order
FROM
    corrected
WHERE
    j.l_shipdate <= CAST('1998-09-02' AS date)
GROUP BY
    j.l_returnflag,
    j.l_linestatus
ORDER BY
    j.l_returnflag,
    j.l_linestatus
----

query IIIIIIIIII nosort q1
with transformed as (
    select json_transform(j, '{"l_orderkey":"integer","l_partkey":"integer","l_suppkey":"integer","l_linenumber":"integer","l_quantity":"integer","l_extendedprice":"real","l_discount":"real","l_tax":"real","l_returnflag":"string","l_linestatus":"string","l_shipdate":"string","l_commitdate":"string","l_receiptdate":"string","l_shipinstruct":"string","l_shipmode":"string","l_comment":"string"}') as j
    from lineitem_j
),
corrected as (
    select cast(j as struct(l_orderkey integer, l_partkey integer, l_suppkey integer, l_linenumber integer, l_quantity integer, l_extendedprice decimal(15,2), l_discount decimal(15,2), l_tax decimal(15,2), l_returnflag varchar, l_linestatus varchar, l_shipdate date, l_commitdate date, l_receiptdate date, l_shipinstruct varchar, l_shipmode varchar, l_comment varchar)) as j
    from transformed
)
SELECT
    j.l_returnflag,
    j.l_linestatus,
    sum(j.l_quantity) AS sum_qty,
    sum(j.l_extendedprice) AS sum_base_price,
    sum(j.l_extendedprice * (1 - j.l_discount)) AS sum_disc_price,
    sum(j.l_extendedprice * (1 - j.l_discount) * (1 + j.l_tax)) AS sum_charge,
    avg(j.l_quantity) AS avg_qty,
    avg(j.l_extendedprice) AS avg_price,
    avg(j.l_discount) AS avg_disc,
    count(*) AS count_order
FROM
    corrected
WHERE
    j.l_shipdate <= CAST('1998-09-02' AS date)
GROUP BY
    j.l_returnflag,
    j.l_linestatus
ORDER BY
    j.l_returnflag,
    j.l_linestatus
----
