# name: test/sql/json/test_json_extract.test
# description: Test JSON typed extract
# group: [json]

require json

statement ok
pragma enable_verification

query T
select json_extract('{"my_field": {"my_nested_field": ["goose", "duck"]}}', '/my_field/my_nested_field/1')
----
"duck"

query T
select json_extract('{"my_field": {"my_nested_field": ["goose", "duckduckduckduck"]}}', '/my_field/my_nested_field/1')
----
"duckduckduckduck"

query T
select json_extract('[1, 2, 42]', 2)
----
42

# some sqlite tests
query T
SELECT json_extract('{"a":2,"c":[4,5,{"f":7}]}', '$');
----
{"a":2,"c":[4,5,{"f":7}]}

query T
SELECT json_extract('{"a":2,"c":[4,5,{"f":7}]}', '$.c');
----
[4,5,{"f":7}]

query T
SELECT json_extract('{"a":2,"c":[4,5,{"f":7}]}', '$.c[2]');
----
{"f":7}

query T
SELECT json_extract('{"a":2,"c":[4,5,{"f":7}]}', '$.c[2].f');
----
7

query T
SELECT json_extract('{"a":2,"c":[4,5,{"f":7}]}', '$.x');
----
NULL

# FIXME: disabled for now until we support json_extract with a list of paths
#query T
#SELECT json_extract('{"a":2,"c":[4,5],"f":7}',['$.c','$.a']);
#----
#[[4,5],2]

#query T
#SELECT json_extract('{"a":2,"c":[4,5,{"f":7}]}', ['$.x', '$.a']);
#----
#[null,2]

statement ok
CREATE TABLE t1(j varchar);

statement ok
INSERT INTO t1(j) VALUES('{"a":1,"b":[1,[2,3],4],"c":99}');

query T
SELECT json_extract(j, '$.b[#]') FROM t1;
----
NULL

query T
SELECT json_extract(j, '$.b[#-1]') FROM t1;
----
4

query T
SELECT json_extract(j, '$.b[#-2]') FROM t1;
----
[2,3]

query T
SELECT json_extract(j, '$.b[#-02]') FROM t1;
----
[2,3]

query T
SELECT json_extract(j, '$.b[#-3]') FROM t1;
----
1

query T
SELECT json_extract(j, '$.b[#-4]') FROM t1;
----
NULL

query T
SELECT json_extract(j, '$.b[#-2][#-1]') FROM t1;
----
3

# FIXME: also disabled until we support json_extract with a list of paths
#query T
#SELECT json_extract(j, ['$.b[0]', '$.b[#-1]']) FROM t1;
#----
#[1,4]

query T
SELECT json_extract(j, '$.a[#-1]') FROM t1;
----
NULL

query T
SELECT json_extract(j, '$.b[#-000001]') FROM t1;
----
4

statement error
SELECT json_extract(j, '$.b[#-]') FROM t1;

statement error
SELECT json_extract(j, '$.b[#9]') FROM t1;

statement error
SELECT json_extract(j, '$.b[#+2]') FROM t1;

statement error
SELECT json_extract(j, '$.b[#-1') FROM t1;

statement error
SELECT json_extract(j, '$.b[#-1x]') FROM t1;

statement ok
CREATE TABLE obj(x varchar);

statement ok
INSERT INTO obj VALUES('{"a":1,"b":2}');

query T
SELECT json_extract(x, '$.b') FROM obj;
----
2

query T
SELECT json_extract(x, '$."b"') FROM obj;
----
2
