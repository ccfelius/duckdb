# name: test/sql/json/test_json_extract.test
# description: Test JSON extract
# group: [json]

require json

statement ok
pragma enable_verification

# basically, if anything goes wrong we return NULL
# users need to know their JSON schema

# tests with constant input and constant query
query T
select json_extract_string('{"str": 42}', 'str')
----
NULL

query T
select json_extract_int('{"str": "quack"}', 'str')
----
NULL

query T
select json_extract_string('{"str": "quack"}', 'str')
----
quack

query T
select json_extract_string('{"str": "quack"}', 'str2')
----
NULL

query T
select json_extract_string('{"str": "quack"}', NULL)
----
NULL

query T
select json_extract_string(NULL, 'str')
----
NULL

# NaN and Infinity should become NULL
query T
select json_extract_string('{"null": NaN}', 'null')
----
NULL

query T
select json_extract_string('{"null": nan}', 'null')
----
NULL

query T
select json_extract_string('{"null": Infinity}', 'null')
----
NULL

query T
select json_extract_string('{"null": -Infinity}', 'null')
----
NULL

statement ok
create table test(json varchar, query varchar)

statement ok
insert into test values
    ('{"str": "quack", "int": 4, "double": 0.42, "bool": true, "arr": [], "nested": {"val": 1}}', '/nested/val'),
    ('{"str": "woof", "int": -4, "double": -0.42, "bool": false, "arr": [0, 1, 2], "nested": {"val": 42}}', '$.arr[2]'),
    ('{"str": null, "int": null, "double": null, "bool": null, "arr": null, "nested": null}', 'bool')

# tests with columnref input and constant query
query T
select json_extract_string(json, 'str') from test
----
quack
woof
NULL

query T
select json_extract_int(json, 'str') from test
----
NULL
NULL
NULL

query T
select json_extract_int(json, 'int') from test
----
4
-4
NULL

query T
select json_extract_double(json, 'double') from test
----
0.42
-0.42
NULL

query T
select json_extract_bool(json, 'bool') from test
----
true
false
NULL

query T
select json_extract_int(json, 'arr') from test
----
NULL
NULL
NULL

# json path queries
query T
select json_extract_int(json, '/arr/0') from test
----
NULL
0
NULL

query T
select json_extract_int(json, '$.arr[0]') from test
----
NULL
0
NULL

query T
select json_extract_int(json, '/nested/val') from test
----
1
42
NULL

query T
select json_extract_int(json, '$.nested.val') from test
----
1
42
NULL

# test with columnref input and columnref query
query T
select json_extract_int(json, query) from test
----
1
2
NULL
