# name: test/sql/json/read_json_dates.test
# description: Read json files - date detection
# group: [json]

require json

# test all supported date formats

foreach date_format '%m-%d-%Y' '%m-%d-%y' '%d-%m-%Y' '%d-%m-%y' '%Y-%m-%d' '%y-%m-%d'

statement ok
copy (
    with cte as (select strftime('1996/03/27'::DATE, ${date_format}) as d)
    select to_json(cte) from cte
) to '__TEST_DIR__/my_file.json' (quote '');

# auto-detect
query I
select * from '__TEST_DIR__/my_file.json'
----
1996-03-27

# forced format
query I
select d from read_json('__TEST_DIR__/my_file.json', columns={d: 'DATE'}, date_format=${date_format})
----
1996-03-27

endloop

# test all supported timestamp formats (hacky way to do foreach parameters that need spaces in them)

foreach a,b,c '%Y-%m-%d,%H:%M:%S.%f,' '%m-%d-%Y,%I:%M:%S,%p' '%m-%d-%y,%I:%M:%S,%p' '%d-%m-%Y,%H:%M:%S,' '%d-%m-%y,%H:%M:%S,' '%Y-%m-%d,%H:%M:%S,' '%y-%m-%d,%H:%M:%S,'

statement ok
copy (
    with cte as (select strftime('1996-03-27 07:42:33'::TIMESTAMP, ${a} ${b} ${c}) as t)
    select to_json(cte) from cte
) to '__TEST_DIR__/my_file.json' (quote '');

# auto-detect
query I
select * from '__TEST_DIR__/my_file.json'
----
1996-03-27 07:42:33

# forced format
query I
select t from read_json('__TEST_DIR__/my_file.json', columns={t: 'TIMESTAMP'}, timestamp_format=${a} ${b} ${c})
----
1996-03-27 07:42:33

endloop

# we can't detect this as timestamp because we don't have this specific format in our auto-detection
# however, we shouldn't error when reading it!
query II
select typeof(createdAt), createdAt from 'data/json/timestamp_example.json'
----
VARCHAR	2023-02-07T19:12:28Z
